<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaskSnap — Photo to Microsoft To Do</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700;800&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
<style>
  :root {
    --bg-primary: #FAF5EF;
    --bg-secondary: #F0EAE0;
    --bg-card: #FFFFFF;
    --bg-card-hover: #F8F4EE;
    --text-primary: #1A1A17;
    --text-secondary: #6B6860;
    --text-tertiary: #9C978E;
    --accent: #B8783D;
    --accent-hover: #A06830;
    --accent-light: rgba(184,120,61,0.12);
    --accent-glow: rgba(184,120,61,0.25);
    --green-primary: #1B4332;
    --green-light: #2D6A4F;
    --green-subtle: rgba(27,67,50,0.08);
    --border: rgba(26,26,23,0.1);
    --border-strong: rgba(26,26,23,0.18);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
    --shadow-lg: 0 12px 40px rgba(0,0,0,0.08);
    --danger: #C44B3F;
    --danger-light: rgba(196,75,63,0.1);
    --success: #2D7A4F;
    --success-light: rgba(45,122,79,0.1);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 18px;
    --radius-xl: 24px;
    --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
  }

  html.dark {
    --bg-primary: #131311;
    --bg-secondary: #1C1C19;
    --bg-card: #222220;
    --bg-card-hover: #2A2A27;
    --text-primary: #EDECE8;
    --text-secondary: #9C9890;
    --text-tertiary: #6B6860;
    --accent: #D4A574;
    --accent-hover: #E0B588;
    --accent-light: rgba(212,165,116,0.12);
    --accent-glow: rgba(212,165,116,0.2);
    --green-primary: #4DA67A;
    --green-light: #6BC494;
    --green-subtle: rgba(77,166,122,0.1);
    --border: rgba(237,236,232,0.08);
    --border-strong: rgba(237,236,232,0.14);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.15);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.2);
    --shadow-lg: 0 12px 40px rgba(0,0,0,0.3);
    --danger: #E06B5F;
    --danger-light: rgba(224,107,95,0.12);
    --success: #4DA67A;
    --success-light: rgba(77,166,122,0.12);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Bricolage Grotesque', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
    line-height: 1.5;
  }

  .bg-pattern {
    position: fixed; inset:0; pointer-events: none; z-index:0;
    background:
      radial-gradient(ellipse 70% 50% at 10% 20%, var(--accent-light) 0%, transparent 70%),
      radial-gradient(ellipse 50% 60% at 90% 80%, var(--green-subtle) 0%, transparent 70%);
  }

  .app-container {
    position: relative; z-index:1;
    max-width: 680px; margin: 0 auto;
    padding: 24px 16px 80px;
  }

  /* Header */
  .header {
    text-align: center; margin-bottom: 32px;
    animation: fadeSlideDown 0.6s ease-out;
  }
  .header-logo {
    display: inline-flex; align-items: center; gap: 10px;
    margin-bottom: 8px;
  }
  .header-logo-icon {
    width: 44px; height: 44px; border-radius: var(--radius-md);
    background: linear-gradient(135deg, var(--green-primary), var(--accent));
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 20px;
    box-shadow: 0 4px 16px var(--accent-glow);
  }
  .header h1 {
    font-size: 28px; font-weight: 800; letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--green-primary), var(--accent));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .header p {
    font-family: 'Source Serif 4', serif;
    font-style: italic; color: var(--text-secondary);
    font-size: 15px; margin-top: 4px;
  }

  /* Stepper */
  .stepper {
    display: flex; align-items: center; justify-content: center; gap: 0;
    margin-bottom: 32px; animation: fadeSlideDown 0.6s ease-out 0.1s both;
  }
  .step-item {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 14px; border-radius: 100px;
    font-size: 13px; font-weight: 600;
    color: var(--text-tertiary);
    transition: var(--transition);
    white-space: nowrap;
  }
  .step-item.active {
    color: var(--accent);
    background: var(--accent-light);
  }
  .step-item.completed {
    color: var(--success);
  }
  .step-num {
    width: 24px; height: 24px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700;
    border: 2px solid var(--border-strong);
    transition: var(--transition);
  }
  .step-item.active .step-num {
    border-color: var(--accent);
    background: var(--accent);
    color: #fff;
  }
  .step-item.completed .step-num {
    border-color: var(--success);
    background: var(--success);
    color: #fff;
  }
  .step-connector {
    width: 24px; height: 2px;
    background: var(--border);
    flex-shrink: 0;
  }
  .step-connector.done { background: var(--success); }

  /* Cards */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 28px 24px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
    animation: fadeSlideUp 0.5s ease-out;
  }
  .card-title {
    font-size: 17px; font-weight: 700; margin-bottom: 6px;
  }
  .card-desc {
    font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;
    line-height: 1.6;
  }

  /* Input Fields */
  .field { margin-bottom: 16px; }
  .field label {
    display: block; font-size: 13px; font-weight: 600;
    color: var(--text-secondary); margin-bottom: 6px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .field input, .field select, .field textarea {
    width: 100%; padding: 12px 14px;
    font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 16px; color: var(--text-primary);
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    outline: none; transition: var(--transition);
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
  }
  .field textarea { resize: vertical; min-height: 80px; }
  .field .hint {
    font-size: 12px; color: var(--text-tertiary); margin-top: 4px;
    line-height: 1.5;
  }
  .field .hint a {
    color: var(--accent); text-decoration: underline;
  }

  /* Buttons */
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 12px 22px; border: none; border-radius: var(--radius-sm);
    font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 15px; font-weight: 600;
    cursor: pointer; transition: var(--transition);
    text-decoration: none; white-space: nowrap;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary {
    background: linear-gradient(135deg, var(--green-primary), var(--green-light));
    color: #fff;
    box-shadow: 0 2px 10px rgba(27,67,50,0.25);
  }
  .btn-primary:hover { box-shadow: 0 4px 18px rgba(27,67,50,0.35); }
  .btn-accent {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: #fff;
    box-shadow: 0 2px 10px var(--accent-glow);
  }
  .btn-accent:hover { box-shadow: 0 4px 18px var(--accent-glow); }
  .btn-outline {
    background: transparent;
    border: 2px solid var(--border-strong);
    color: var(--text-primary);
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger {
    background: var(--danger-light);
    color: var(--danger);
  }
  .btn-sm { padding: 8px 14px; font-size: 13px; }
  .btn-block { width: 100%; }
  .btn:disabled {
    opacity: 0.5; cursor: not-allowed;
    transform: none !important;
  }

  /* Microsoft sign-in button */
  .btn-microsoft {
    background: var(--bg-card);
    border: 2px solid var(--border-strong);
    color: var(--text-primary);
    font-weight: 600;
    padding: 14px 22px;
  }
  .btn-microsoft:hover {
    border-color: #0078d4;
    background: rgba(0,120,212,0.05);
  }
  .btn-microsoft .ms-logo {
    width: 20px; height: 20px;
  }

  /* Upload Zone */
  .upload-zone {
    border: 2px dashed var(--border-strong);
    border-radius: var(--radius-lg);
    padding: 40px 24px;
    text-align: center; cursor: pointer;
    transition: var(--transition);
    position: relative; overflow: hidden;
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent);
    background: var(--accent-light);
  }
  .upload-zone input { display: none; }
  .upload-icon {
    font-size: 36px; color: var(--accent);
    margin-bottom: 12px;
  }
  .upload-zone h3 {
    font-size: 16px; font-weight: 600; margin-bottom: 4px;
  }
  .upload-zone p {
    font-size: 13px; color: var(--text-tertiary);
  }
  .upload-preview {
    position: relative; margin-top: 16px;
    border-radius: var(--radius-md); overflow: hidden;
    display: none;
  }
  .upload-preview img {
    width: 100%; max-height: 320px; object-fit: contain;
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
  }
  .upload-preview .remove-img {
    position: absolute; top: 8px; right: 8px;
    width: 32px; height: 32px; border-radius: 50%;
    background: rgba(0,0,0,0.6); color: #fff; border: none;
    cursor: pointer; font-size: 14px;
    display: flex; align-items: center; justify-content: center;
  }

  /* Task List */
  .task-list { display: flex; flex-direction: column; gap: 12px; }
  .task-section-label {
    display: flex; align-items: center; gap: 8px;
    font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 13px; font-weight: 700; letter-spacing: 0.04em;
    text-transform: uppercase; margin: 6px 0 4px;
    color: var(--text-tertiary);
  }
  .task-section-label i { font-size: 12px; }
  .task-section-label.priority {
    color: var(--danger);
  }
  .task-section-label.priority i {
    animation: pulse-glow 2s ease-in-out infinite;
  }
  @keyframes pulse-glow {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
  }
  .task-section-divider {
    height: 1px; background: var(--border); margin: 10px 0 4px;
  }
  .task-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 16px 18px;
    transition: var(--transition);
    animation: fadeSlideUp 0.4s ease-out both;
  }
  .task-card.unchecked-task { opacity: 0.55; }
  .task-card.priority-task {
    border-left: 3px solid var(--danger);
    background: var(--danger-light);
  }
  .task-card.priority-task:hover { border-color: var(--danger); }
  .task-card:hover { border-color: var(--border-strong); box-shadow: var(--shadow-md); }
  .task-card-header {
    display: flex; align-items: flex-start; justify-content: space-between; gap: 10px;
  }
  .task-check {
    width: 20px; height: 20px; min-width: 20px;
    margin-top: 2px; accent-color: var(--accent);
    cursor: pointer;
  }
  .task-card.priority-task .task-check { accent-color: var(--danger); }

  /* Photo thumbnail in review */
  .photo-thumb-row {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 14px; padding: 10px 12px;
    background: var(--bg-secondary); border-radius: var(--radius-md);
    cursor: pointer; transition: var(--transition);
  }
  .photo-thumb-row:hover { background: var(--bg-card-hover); }
  .photo-thumb-row img {
    width: 56px; height: 56px; object-fit: cover;
    border-radius: 8px; border: 1px solid var(--border);
  }
  .photo-thumb-row .thumb-label {
    font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 13px; color: var(--text-secondary);
  }
  .photo-thumb-row .thumb-label span {
    display: block; font-size: 11px; color: var(--text-tertiary); margin-top: 2px;
  }

  /* Lightbox */
  .lightbox-overlay {
    display: none; position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.88); flex-direction: column;
    align-items: center; justify-content: center;
  }
  .lightbox-overlay.open { display: flex; }
  .lightbox-close {
    position: absolute; top: 12px; right: 16px;
    background: rgba(255,255,255,0.15); border: none;
    color: #fff; font-size: 22px; width: 40px; height: 40px;
    border-radius: 50%; cursor: pointer; z-index: 10;
    display: flex; align-items: center; justify-content: center;
  }
  .lightbox-close:hover { background: rgba(255,255,255,0.3); }
  .lightbox-img-wrap {
    width: 100%; height: 100%;
    overflow: auto; display: flex;
    align-items: center; justify-content: center;
    padding: 16px;
    box-sizing: border-box;
  }
  .lightbox-img-wrap img {
    max-width: 100%; max-height: 100%;
    object-fit: contain;
    transition: transform 0.2s ease;
    transform-origin: center center;
    cursor: zoom-in; user-select: none;
    -webkit-user-drag: none;
  }
  .lightbox-img-wrap img.zoomed {
    max-width: none; max-height: none;
    cursor: grab;
  }
  .task-title-input {
    flex: 1; font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 16px; font-weight: 600;
    color: var(--text-primary);
    background: transparent; border: none; outline: none;
    padding: 0; width: 100%;
  }
  .task-title-input:focus {
    border-bottom: 2px solid var(--accent);
    padding-bottom: 4px;
  }
  .task-body-input {
    width: 100%; margin-top: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px; color: var(--text-secondary);
    background: transparent; border: none; outline: none;
    resize: none; min-height: 24px; padding: 0;
  }
  .task-body-input:focus {
    border-bottom: 1px solid var(--accent);
    padding-bottom: 4px;
  }
  .task-meta {
    display: flex; align-items: center; gap: 12px;
    margin-top: 10px; flex-wrap: wrap;
  }
  .task-due {
    display: flex; align-items: center; gap: 6px;
    font-size: 13px; color: var(--text-tertiary);
  }
  .task-due input[type="time"] {
    font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 13px; color: var(--accent);
    background: var(--accent-light);
    border: none; border-radius: 6px;
    padding: 4px 8px; outline: none;
  }
  .cal-trigger {
    font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 13px; color: var(--accent);
    background: var(--accent-light);
    border: none; border-radius: 6px;
    padding: 4px 10px; outline: none;
    cursor: pointer; white-space: nowrap;
    min-height: 28px; display: inline-flex;
    align-items: center; gap: 4px;
  }
  .cal-trigger:hover { background: var(--accent-glow); }
  .cal-trigger .placeholder { color: var(--text-tertiary); }
  .cal-popup {
    position: absolute; z-index: 100;
    background: var(--bg-card); border: 1px solid var(--border-strong);
    border-radius: var(--radius-md); box-shadow: var(--shadow-lg);
    padding: 12px; width: 280px;
    display: none;
  }
  .cal-popup.open { display: block; }
  .cal-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px;
  }
  .cal-header button {
    background: none; border: none; cursor: pointer;
    color: var(--text-secondary); font-size: 16px; padding: 4px 8px;
    border-radius: 6px;
  }
  .cal-header button:hover { background: var(--bg-secondary); }
  .cal-header .cal-month-year {
    font-weight: 600; font-size: 14px; color: var(--text-primary);
  }
  .cal-grid {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 2px; text-align: center;
  }
  .cal-grid .cal-dow {
    font-size: 11px; font-weight: 600; color: var(--text-tertiary);
    padding: 4px 0; text-transform: uppercase;
  }
  .cal-grid .cal-day {
    font-size: 13px; padding: 6px 0; border-radius: 6px;
    cursor: pointer; color: var(--text-primary); border: none;
    background: none;
  }
  .cal-grid .cal-day:hover { background: var(--accent-light); }
  .cal-grid .cal-day.other-month { color: var(--text-tertiary); opacity: 0.5; }
  .cal-grid .cal-day.today { font-weight: 700; box-shadow: inset 0 0 0 1.5px var(--accent); }
  .cal-grid .cal-day.selected { background: var(--accent); color: #fff; font-weight: 600; }
  .cal-clear-row { margin-top: 6px; text-align: right; }
  .cal-clear-btn {
    font-size: 12px; color: var(--danger); background: none;
    border: none; cursor: pointer; padding: 2px 6px;
  }
  .cal-clear-btn:hover { text-decoration: underline; }

  .smart-input-box {
    border: 1.5px dashed var(--border-strong);
    border-radius: var(--radius-md);
    background: var(--bg-card-hover);
    transition: border-color var(--transition);
    overflow: hidden;
  }
  .smart-input-box:focus-within { border-color: var(--accent); }
  .smart-input-box textarea {
    width: 100%; border: none; background: transparent;
    padding: 12px 14px; font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 16px; color: var(--text-primary);
    resize: vertical; min-height: 60px; outline: none;
    line-height: 1.5;
  }
  .smart-input-box textarea::placeholder { color: var(--text-tertiary); font-size: 14px; }
  #smartPastePreview {
    position: relative; padding: 8px 14px 12px;
    border-top: 1px solid var(--border);
  }
  #smartPastePreview img {
    max-width: 120px; max-height: 90px; border-radius: 8px;
    object-fit: cover; border: 1px solid var(--border);
  }
  #smartPasteRemove {
    position: absolute; top: 4px; left: 126px;
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--danger); color: #fff; border: none;
    font-size: 11px; cursor: pointer; display: flex;
    align-items: center; justify-content: center;
  }
  .task-actions { display: flex; gap: 6px; }
  .task-remove {
    width: 28px; height: 28px; border-radius: 6px;
    border: none; background: var(--danger-light);
    color: var(--danger); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; transition: var(--transition);
    flex-shrink: 0;
  }
  .task-remove:hover { background: var(--danger); color: #fff; }
  .task-synced {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 12px; font-weight: 600;
    color: var(--success); background: var(--success-light);
    padding: 3px 10px; border-radius: 100px;
  }

  /* Loading / Spinner */
  .spinner {
    width: 32px; height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 16px auto;
  }
  .loading-text {
    text-align: center; font-size: 14px;
    color: var(--text-secondary); margin-top: 8px;
  }

  /* Section visibility */
  .section { display: none; }
  .section.visible { display: block; }

  /* Auth status bar */
  .auth-status {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    background: var(--success-light);
    margin-bottom: 16px;
    font-size: 14px; font-weight: 600;
    color: var(--success);
  }
  .auth-status .avatar {
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--success);
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700;
  }
  .auth-status .logout-btn {
    margin-left: auto; font-size: 12px; cursor: pointer;
    color: var(--text-tertiary); background: none; border: none;
    text-decoration: underline;
  }
  .auth-status .token-expiry {
    font-size: 11px; font-weight: 600;
    padding: 2px 8px; border-radius: 100px;
    white-space: nowrap;
  }
  .auth-status .token-expiry.ok {
    background: var(--success-light); color: var(--success);
  }
  .auth-status .token-expiry.warning {
    background: rgba(212,165,60,0.15); color: #B08A2A;
  }
  .auth-status .token-expiry.expired {
    background: var(--danger-light); color: var(--danger);
  }

  /* Error detail banner in sync section */
  .error-detail {
    background: var(--danger-light);
    border: 1px solid var(--danger);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    margin-top: 16px; font-size: 13px;
    color: var(--danger); line-height: 1.6;
  }
  .error-detail strong { display: block; margin-bottom: 4px; font-size: 14px; }
  .error-detail code {
    background: rgba(0,0,0,0.06); padding: 1px 5px;
    border-radius: 3px; font-size: 12px;
  }
  html.dark .error-detail code { background: rgba(255,255,255,0.08); }

  /* Timezone picker */
  .tz-row {
    display: flex; gap: 12px; align-items: flex-end;
    margin-bottom: 16px;
  }
  .tz-row .field { flex: 1; margin-bottom: 0; }

  /* PIN / toggle button */
  .pin-field-wrap { position: relative; }
  .pin-toggle-btn {
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    background: none; border: none; color: var(--text-tertiary);
    cursor: pointer; font-size: 15px; padding: 4px; z-index: 2;
  }
  .pin-toggle-btn:hover { color: var(--accent); }
  .pin-field-wrap input { padding-right: 44px; -webkit-text-security: none; text-security: none; }
  .pin-links { font-size: 12px; margin-top: 6px; display: flex; gap: 14px; }
  .pin-links a {
    color: var(--accent); cursor: pointer; text-decoration: none;
  }
  .pin-links a:hover { text-decoration: underline; }
  .pin-error { color: var(--danger); font-size: 12px; margin-top: 4px; display: none; }

  /* Confirm dialog overlay */
  .confirm-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center; z-index: 200;
  }
  .confirm-box {
    background: var(--bg-card); border-radius: var(--radius-md); padding: 24px;
    max-width: 340px; width: 90%; box-shadow: var(--shadow-lg);
  }
  .confirm-box p { color: var(--text-primary); font-size: 14px; line-height: 1.5; margin-bottom: 16px; }
  .confirm-box .confirm-actions { display: flex; justify-content: flex-end; gap: 10px; }

  .modal-custom-section { margin-bottom: 16px; }
  .modal-custom-label {
    display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
  }
  .modal-custom-label i { font-size: 13px; }
  .modal-custom-label span {
    font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
  }
  .modal-custom-label .custom-matched { color: var(--accent); }
  .modal-custom-label .custom-unmatched { color: var(--danger); }
  .modal-unmatched-hint {
    font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4;
  }
  .modal-new-list-input:disabled {
    opacity: 0.4; cursor: not-allowed; background: var(--bg-secondary);
  }

  /* Action bar */
  .action-bar {
    display: flex; gap: 10px; margin-top: 20px;
    flex-wrap: wrap;
  }

  /* Results summary */
  .sync-summary {
    text-align: center; padding: 24px;
  }
  .sync-summary .big-icon {
    font-size: 52px; color: var(--success);
    margin-bottom: 12px;
  }
  .sync-summary h2 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
  .sync-summary p { color: var(--text-secondary); font-size: 15px; }

  /* Modal */
  .modal-overlay {
    position: fixed; inset:0; z-index: 1000;
    background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    padding: 20px; opacity: 0; pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }
  .modal-box {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 28px 24px;
    max-width: 440px; width: 100%;
    box-shadow: var(--shadow-lg);
    transform: translateY(16px);
    transition: transform 0.25s ease;
  }
  .modal-overlay.open .modal-box { transform: translateY(0); }
  .modal-box h3 { font-size: 18px; font-weight: 700; margin-bottom: 12px; }
  .modal-box p { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

  /* Toast */
  .toast-container {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    z-index: 2000; display: flex; flex-direction: column; gap: 8px;
    pointer-events: none;
  }
  .toast {
    padding: 12px 20px; border-radius: var(--radius-sm);
    font-size: 14px; font-weight: 600;
    box-shadow: var(--shadow-lg);
    animation: toastIn 0.4s ease-out;
    pointer-events: auto;
  }
  .toast.error { background: var(--danger); color: #fff; }
  .toast.success { background: var(--success); color: #fff; }
  .toast.info { background: var(--green-primary); color: #fff; }

  /* Scrollable select */
  .list-select-wrapper {
    position: relative;
  }

  /* Empty state */
  .empty-state {
    text-align: center; padding: 32px 16px;
    color: var(--text-tertiary);
  }
  .empty-state i { font-size: 36px; margin-bottom: 12px; display: block; }

  /* Responsive */
  @media (max-width: 480px) {
    .app-container { padding: 16px 12px 80px; }
    .card { padding: 20px 16px; }
    .header h1 { font-size: 24px; }
    .step-item { padding: 4px 8px; font-size: 11px; }
    .step-item span:not(.step-num) { display: none; }
    .step-connector { width: 16px; }
  }

  /* Animations */
  @keyframes fadeSlideDown {
    from { opacity:0; transform: translateY(-16px); }
    to { opacity:1; transform: translateY(0); }
  }
  @keyframes fadeSlideUp {
    from { opacity:0; transform: translateY(16px); }
    to { opacity:1; transform: translateY(0); }
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  @keyframes toastIn {
    from { opacity:0; transform: translateY(12px); }
    to { opacity:1; transform: translateY(0); }
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .animate-pulse { animation: pulse 2s ease-in-out infinite; }

  /* Collapsible setup instructions */
  .instructions-toggle {
    display: flex; align-items: center; gap: 8px;
    cursor: pointer; font-size: 13px; font-weight: 600;
    color: var(--accent); margin-bottom: 12px;
    background: none; border: none;
    font-family: 'Bricolage Grotesque', sans-serif;
  }
  .instructions-toggle i { transition: transform 0.25s ease; }
  .instructions-toggle.expanded i { transform: rotate(90deg); }
  .instructions-body {
    display: none; font-size: 13px; color: var(--text-secondary);
    line-height: 1.8; padding: 12px 16px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    margin-bottom: 16px;
  }
  .instructions-body.show { display: block; }
  .instructions-body ol { padding-left: 18px; }
  .instructions-body code {
    background: var(--accent-light); color: var(--accent);
    padding: 1px 6px; border-radius: 4px; font-size: 12px;
  }

  /* Add task button */
  .add-task-btn {
    width: 100%; padding: 12px;
    border: 2px dashed var(--border-strong);
    border-radius: var(--radius-md);
    background: transparent;
    color: var(--text-tertiary);
    font-family: 'Bricolage Grotesque', sans-serif;
    font-size: 14px; font-weight: 600;
    cursor: pointer; transition: var(--transition);
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .add-task-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-light);
  }

  /* Progress bar for sync */
  .sync-progress {
    width: 100%; height: 6px; border-radius: 3px;
    background: var(--bg-secondary); overflow: hidden;
    margin: 16px 0;
  }
  .sync-progress-bar {
    height: 100%; border-radius: 3px;
    background: linear-gradient(90deg, var(--green-primary), var(--accent));
    transition: width 0.4s ease;
  }
</style>
</head>
<body>

<div class="bg-pattern"></div>

<div class="app-container">

  <!-- Header -->
  <div class="header">
    <div class="header-logo">
      <div class="header-logo-icon"><i class="fas fa-camera-retro"></i></div>
      <h1>TaskSnap</h1>
    </div>
    <p>Photograph your to-do list, sync it to Microsoft To&nbsp;Do</p>
  </div>

  <!-- Stepper -->
  <div class="stepper" id="stepper">
    <div class="step-item active" data-step="1">
      <span class="step-num">1</span><span>Connect</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-item" data-step="2">
      <span class="step-num">2</span><span>Input</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-item" data-step="3">
      <span class="step-num">3</span><span>Review</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-item" data-step="4">
      <span class="step-num">4</span><span>Sync</span>
    </div>
  </div>

  <!-- ======= SECTION 1: AUTH ======= -->
  <div class="section visible" id="section-auth">
    <div class="card" id="msalCard">
      <div class="card-title">Connect to Microsoft</div>
      <div class="card-desc">
        Sign in with your Microsoft account to sync tasks to Microsoft&nbsp;To&nbsp;Do. Your session stays active for up to 90&nbsp;days.
      </div>

      <button class="instructions-toggle" id="instrToggle" type="button">
        <i class="fas fa-chevron-right"></i> First-time setup (Azure AD app)
      </button>
      <div class="instructions-body" id="instrBody">
        <ol>
          <li>Go to <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" rel="noopener">Azure AD &gt; App registrations</a></li>
          <li>Click <strong>New registration</strong>, name it (e.g. &ldquo;TaskSnap&rdquo;)</li>
          <li>Under <strong>Supported account types</strong>, choose <em>Personal Microsoft accounts only</em> or <em>Accounts in any org &amp; personal</em></li>
          <li>Under <strong>Redirect URI</strong>, select <strong>Single-page application (SPA)</strong> and enter your app&rsquo;s URL (e.g. <code>https://yourdomain.com</code>)</li>
          <li>Click <strong>Register</strong>, then copy the <strong>Application (client) ID</strong></li>
          <li>Go to <strong>API permissions</strong> &gt; Add &gt; Microsoft Graph &gt; Delegated &gt; add <code>Tasks.ReadWrite</code> and <code>User.Read</code></li>
        </ol>
        <div style="margin-top:10px; padding:10px 12px; border-radius:8px; background:var(--accent-light); font-size:12px; line-height:1.6;">
          <strong><i class="fas fa-circle-info"></i> Long-lived sessions</strong><br>
          This version uses MSAL.js with refresh tokens. Once you sign in, your session stays active for up to <strong>90 days</strong> without re-login. Tokens are cached in your browser&rsquo;s localStorage.
        </div>
      </div>

      <div class="field" style="margin-top:16px;">
        <label>Azure App Client ID <span style="font-weight:400; text-transform:none; letter-spacing:0;">(not a login)</span></label>
        <input type="text" id="clientIdInput" name="azure_client_id" placeholder="e.g. 12345678-abcd-1234-abcd-1234567890ab" autocomplete="one-time-code" data-form-type="other" data-lpignore="true">
        <div class="hint">Found in Azure AD &gt; App registrations &gt; Overview</div>
      </div>

      <button class="btn btn-microsoft btn-block" id="msalLoginBtn" type="button">
        <svg class="ms-logo" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
        Sign in with Microsoft
      </button>

      <div id="msalStatusMsg" style="text-align:center; margin-top:8px; font-size:13px; color:var(--text-secondary); display:none;"></div>
    </div>

    <!-- Session restored banner (hidden by default, shown when MSAL auto-login restores session) -->
    <div id="sessionRestoredBanner" class="card" style="display:none; border-left:4px solid var(--success); background:var(--success-light);">
      <div style="display:flex; align-items:center; gap:10px;">
        <i class="fas fa-circle-check" style="color:var(--success); font-size:20px;"></i>
        <div>
          <div style="font-weight:600; color:var(--text-primary); font-size:15px;">Microsoft session active</div>
          <div id="sessionRestoredUser" style="font-size:13px; color:var(--text-secondary); margin-top:2px;">Signed in — enter your Poe API key below to continue.</div>
        </div>
      </div>
    </div>

    <div class="card" id="poeKeyCard">
      <div class="card-title" style="font-size:16px;"><i class="fas fa-robot" style="margin-right:6px;"></i> Poe API Key</div>

      <!-- STATE A: Full API key + PIN setup (first time or change key) -->
      <div id="pinStateA">
        <div class="card-desc" id="pinStateADesc">
          Used for AI-powered task extraction. Get your key from <a href="https://poe.com/api_key" target="_blank" rel="noopener"><strong>poe.com/api_key</strong></a>.
        </div>
        <div class="field">
          <div class="pin-field-wrap">
            <input type="password" id="poeApiKeyInput" name="poe_api_token" placeholder="Enter your Poe API key" autocomplete="one-time-code" data-form-type="other" data-lpignore="true" style="font-size:16px;">
            <button type="button" class="pin-toggle-btn" data-target="poeApiKeyInput" title="Show/hide key"><i class="fas fa-eye"></i></button>
          </div>
        </div>
        <div style="margin-top:4px; margin-bottom:8px;">
          <div style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:6px;"><i class="fas fa-lock" style="margin-right:4px;"></i> Set a PIN to save this key</div>
          <div class="field" style="margin-bottom:8px;">
            <div class="pin-field-wrap">
              <input type="text" id="pinSetInput" placeholder="Enter 6-character PIN" maxlength="6" autocomplete="one-time-code" data-form-type="other" data-lpignore="true" style="font-size:16px;">
              <button type="button" class="pin-toggle-btn" data-target="pinSetInput" title="Show/hide PIN"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <div class="field" style="margin-bottom:4px;">
            <div class="pin-field-wrap">
              <input type="text" id="pinConfirmInput" placeholder="Confirm PIN" maxlength="6" autocomplete="one-time-code" data-form-type="other" data-lpignore="true" style="font-size:16px;">
              <button type="button" class="pin-toggle-btn" data-target="pinConfirmInput" title="Show/hide PIN"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <div class="hint">Alphanumeric, exactly 6 characters. Your key is encrypted locally — PIN is never stored.</div>
          <div class="pin-error" id="pinSetError"></div>
        </div>
        <div id="pinStateACancel" style="display:none; margin-bottom:8px;">
          <div class="pin-links"><a id="pinCancelChangeBtn">Cancel</a></div>
        </div>
      </div>

      <!-- STATE B: PIN unlock (return visit with saved key) -->
      <div id="pinStateB" style="display:none;">
        <div class="card-desc">Your key is saved. Enter your PIN to unlock.</div>
        <div class="field" style="margin-bottom:4px;">
          <div class="pin-field-wrap">
            <input type="text" id="pinUnlockInput" placeholder="Enter 6-character PIN" maxlength="6" autocomplete="one-time-code" data-form-type="other" data-lpignore="true" style="font-size:16px;">
            <button type="button" class="pin-toggle-btn" data-target="pinUnlockInput" title="Show/hide PIN"><i class="fas fa-eye"></i></button>
          </div>
          <div class="pin-error" id="pinUnlockError"></div>
        </div>
        <div class="pin-links">
          <a id="forgotPinBtn">Forgot PIN?</a>
          <a id="changeApiKeyBtn">Change API key</a>
        </div>
      </div>

      <button class="btn btn-block" id="continueToUploadBtn" type="button" style="display:none; margin-top:12px; background:var(--accent); color:#fff;">
        <i class="fas fa-arrow-right" style="margin-right:6px;"></i> Continue to input
      </button>
    </div>
  </div>

  <!-- ======= SECTION 2: UPLOAD ======= -->
  <div class="section" id="section-upload">
    <div class="auth-status" id="authStatusBar">
      <div class="avatar" id="userAvatar">?</div>
      <span id="userName">Signed in</span>
      <span class="token-expiry ok" id="tokenExpiryBadge" style="display:none;"></span>
      <button class="logout-btn" id="logoutBtn" type="button">Sign out</button>
    </div>

    <div class="card">
      <div style="font-size:13px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:6px;">
        Upload an image of a handwritten or printed to-do list
      </div>

      <div class="upload-zone" id="uploadZone">
        <input type="file" id="imageInput" accept="image/*">
        <div class="upload-icon"><i class="fas fa-cloud-arrow-up"></i></div>
        <h3>Tap to upload or drag &amp; drop</h3>
        <p>PNG, JPG, WebP — max 20 MB</p>
      </div>

      <div class="upload-preview" id="uploadPreview">
        <img id="previewImg" alt="Uploaded preview">
        <button class="remove-img" id="removeImgBtn" type="button"><i class="fas fa-xmark"></i></button>
      </div>

      <div class="smart-input-wrap" style="margin-top:16px;">
        <label style="font-size:13px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:6px;">
          Smart Input <span style="font-weight:400; text-transform:none; letter-spacing:0;">(optional)</span>
        </label>
        <div class="smart-input-box" id="smartInputBox">
          <textarea id="smartTextInput" placeholder="Type a task or instruction, and / or paste an image" rows="2"></textarea>
          <div id="smartPastePreview" style="display:none;">
            <img id="smartPasteImg" alt="Pasted image">
            <button type="button" id="smartPasteRemove" title="Remove pasted image"><i class="fas fa-xmark"></i></button>
          </div>
        </div>
      </div>

      <div class="tz-row" style="margin-top:18px;">
        <div class="field">
          <label>Timezone for due dates</label>
          <select id="timezoneSelect"></select>
        </div>
      </div>

      <button class="btn btn-accent btn-block" id="extractBtn" type="button" disabled>
        <i class="fas fa-wand-magic-sparkles"></i> Extract tasks with AI
      </button>

      <label id="liteModeLabel" style="display:flex; align-items:center; gap:10px; margin-top:14px; cursor:pointer; padding:10px 12px; background:var(--accent-light); border-radius:var(--radius-sm); font-size:14px; font-weight:600; color:var(--accent);">
        <input type="checkbox" id="liteModeCheck" checked style="width:18px; height:18px; accent-color:var(--accent); cursor:pointer;">
        <span><i class="fas fa-bolt" style="margin-right:4px;"></i> Lite mode — bypass review</span>
      </label>
    </div>
  </div>

  <!-- ======= SECTION 3: REVIEW ======= -->
  <div class="section" id="section-review">
    <div class="card">
      <div class="card-title">Review extracted tasks</div>
      <div class="card-desc">
        Edit titles, notes, and due dates before syncing. Remove any tasks you don't need.
      </div>

      <div id="photoThumbRow" class="photo-thumb-row" style="display:none;">
        <img id="photoThumbImg" alt="Source photo">
        <div class="thumb-label">
          <strong>Source photo</strong>
          <span>Tap to zoom &amp; pan</span>
        </div>
      </div>

      <div id="extractionLoading" style="display:none;">
        <div class="spinner"></div>
        <div class="loading-text animate-pulse">Analyzing your to-do list…</div>
      </div>

      <div id="photoDateRow" style="display:none; margin-bottom:16px;">
        <div class="field" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <label style="margin:0; white-space:nowrap;"><i class="fas fa-camera-retro" style="margin-right:4px;"></i> Photo Date</label>
          <input type="date" id="photoDateInput" style="font-size:16px; padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--fg); min-width:160px;">
          <span id="photoDateInfo" style="font-size:0.82rem; color:var(--muted);"></span>
        </div>
      </div>

      <div class="task-list" id="taskList"></div>

      <button class="add-task-btn" id="addTaskBtn" type="button" style="margin-top:12px; display:none;">
        <i class="fas fa-plus"></i> Add task manually
      </button>

      <div class="action-bar" id="reviewActions" style="display:none;">
        <button class="btn btn-outline" id="backToUploadBtn" type="button">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="btn btn-primary" id="syncBtn" type="button" style="flex:1;">
          <i class="fas fa-cloud-arrow-up"></i> Sync to Microsoft To Do
        </button>
      </div>
    </div>
  </div>

  <!-- ======= SECTION 4: SYNC ======= -->
  <div class="section" id="section-sync">
    <div class="card" id="syncingCard">
      <div class="card-title">Syncing tasks…</div>
      <div class="card-desc" id="syncStatusText">Choosing your task list…</div>
      <div class="sync-progress">
        <div class="sync-progress-bar" id="syncProgressBar" style="width: 0%"></div>
      </div>
    </div>

    <div class="card" id="syncDoneCard" style="display:none;">
      <div class="sync-summary">
        <div class="big-icon" id="syncDoneIcon"><i class="fas fa-circle-check"></i></div>
        <h2 id="syncDoneTitle">All synced!</h2>
        <p id="syncDoneText">Your tasks are now in Microsoft To Do.</p>
      </div>
      <div id="syncErrorDetail" style="display:none;"></div>
      <div class="action-bar" style="justify-content:center; flex-wrap:wrap;">
        <button class="btn btn-outline btn-sm" id="reAuthBtn" type="button" style="display:none;">
          <i class="fas fa-rotate-right"></i> Re-authenticate
        </button>
        <button class="btn btn-outline btn-sm" id="retryFailedBtn" type="button" style="display:none;">
          <i class="fas fa-arrow-rotate-left"></i> Retry failed tasks
        </button>
        <button class="btn btn-accent" id="newScanBtn" type="button">
          <i class="fas fa-camera-retro"></i> Input more tasks
        </button>
      </div>
    </div>
  </div>

  <!-- ======= LIST SELECTOR MODAL ======= -->
  <div class="modal-overlay" id="listModal">
    <div class="modal-box">
      <h3>Choose task lists</h3>
      <p>Select which Microsoft To Do list each group should sync to.</p>

      <!-- Priority tasks section -->
      <div id="modalPrioritySection" style="display:none;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <i class="fas fa-fire" style="color:var(--danger); font-size:13px;"></i>
          <span style="font-size:13px; font-weight:700; color:var(--danger); text-transform:uppercase; letter-spacing:0.04em;" id="modalPriorityLabel">Priority (0)</span>
        </div>
        <div class="field" style="margin-bottom:8px;">
          <select id="listSelectPriority">
            <option value="">Loading lists…</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:16px;">
          <input type="text" id="newListInputPriority" placeholder="Or create new list (optional)">
        </div>
      </div>

      <!-- Other tasks section -->
      <div id="modalOtherSection" style="display:none;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <i class="fas fa-list-check" style="color:var(--text-tertiary); font-size:13px;"></i>
          <span style="font-size:13px; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.04em;" id="modalOtherLabel">Other Tasks (0)</span>
        </div>
        <div class="field" style="margin-bottom:8px;">
          <select id="listSelectOther">
            <option value="">Loading lists…</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:16px;">
          <input type="text" id="newListInputOther" placeholder="Or create new list (optional)">
        </div>
      </div>

      <!-- Event registration tasks section -->
      <div id="modalEventSection" style="display:none;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <i class="fas fa-ticket" style="color:var(--danger); font-size:13px;"></i>
          <span style="font-size:13px; font-weight:700; color:var(--danger); text-transform:uppercase; letter-spacing:0.04em;" id="modalEventLabel">Event Registration (0)</span>
        </div>
        <div class="field" style="margin-bottom:8px;">
          <select id="listSelectEvent">
            <option value="">Loading lists…</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:16px;">
          <input type="text" id="newListInputEvent" placeholder="Or create new list (optional)">
        </div>
      </div>

      <!-- Custom list override sections (dynamically populated) -->
      <div id="modalCustomSections"></div>

      <!-- No matching list sections (dynamically populated) -->
      <div id="modalUnmatchedSections"></div>

      <div class="modal-actions">
        <button class="btn btn-outline btn-sm" id="listModalCancel" type="button">Cancel</button>
        <button class="btn btn-primary btn-sm" id="listModalConfirm" type="button">
          <i class="fas fa-check"></i> Confirm
        </button>
      </div>
    </div>
  </div>

</div>

<div class="toast-container" id="toastContainer"></div>

<!-- Lightbox overlay -->
<div class="lightbox-overlay" id="lightboxOverlay">
  <button class="lightbox-close" id="lightboxClose" type="button"><i class="fas fa-xmark"></i></button>
  <div class="lightbox-img-wrap" id="lightboxWrap">
    <img id="lightboxImg" alt="Full photo">
  </div>
</div>

<script>
(function() {
  "use strict";

  // ========== DARK MODE ==========
  if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
    document.documentElement.classList.add("dark");
  }
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", function(e) {
    if (e.matches) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  });

  // ========== ENVIRONMENT CHECK ==========
  // This app requires localStorage (for MSAL.js auth tokens and settings).
  // It must be hosted on an https:// domain — it cannot run inside sandboxed iframes.
  var storageAvailable = false;
  try {
    var testKey = "__tasksnap_test__";
    window["localStorage"].setItem(testKey, "1");
    window["localStorage"].removeItem(testKey);
    storageAvailable = true;
  } catch(e) {
    storageAvailable = false;
  }

  if (!storageAvailable) {
    var container = document.querySelector(".app-container");
    if (container) {
      container.innerHTML =
        '<div class="header">' +
          '<div class="header-logo">' +
            '<div class="header-logo-icon"><i class="fas fa-camera-retro"></i></div>' +
            '<h1>TaskSnap</h1>' +
          '</div>' +
        '</div>' +
        '<div class="card" style="text-align:center;">' +
          '<div style="font-size:48px; margin-bottom:16px; color:var(--accent);"><i class="fas fa-globe"></i></div>' +
          '<h2 style="font-size:20px; font-weight:700; margin-bottom:12px;">Self-hosted app</h2>' +
          '<p style="color:var(--text-secondary); line-height:1.7; font-size:14px; max-width:480px; margin:0 auto;">' +
            'This app needs to be hosted on your own <strong>https://</strong> domain to work. ' +
            'It uses <strong>MSAL.js</strong> to keep you signed in to Microsoft for up to 90 days, ' +
            'which requires browser storage (localStorage) that isn\'t available in sandboxed iframes.' +
          '</p>' +
          '<div style="margin-top:20px; padding:16px; background:var(--bg-secondary); border-radius:12px; text-align:left; font-size:13px; color:var(--text-secondary); line-height:1.8;">' +
            '<strong style="color:var(--text-primary);">Quick start:</strong><br>' +
            '1. Save this HTML file<br>' +
            '2. Host it on any static host (GitHub Pages, Netlify, Vercel, etc.)<br>' +
            '3. Register an Azure AD app with the hosted URL as SPA redirect URI<br>' +
            '4. Open the hosted URL in your browser' +
          '</div>' +
        '</div>';
    }
    return; // Stop all further initialization
  }

  // ========== STATE ==========
  var state = {
    currentStep: 1,
    accessToken: "",
    tokenExpiresAt: 0,
    userInfo: null,
    uploadedFile: null,
    photoDataUrl: null,
    photoDate: null,
    tasks: [],
    lists: [],
    selectedListId: "",
    lastSyncListId: "",
    expiryTimerId: null,
    msalInstance: null
  };

  // ========== DOM REFS ==========
  var $id = function(id) { return document.getElementById(id); };

  var msalCard = $id("msalCard");
  var instrToggle = $id("instrToggle");
  var instrBody = $id("instrBody");
  var clientIdInput = $id("clientIdInput");
  var msalLoginBtn = $id("msalLoginBtn");
  var msalStatusMsg = $id("msalStatusMsg");
  var poeApiKeyInput = $id("poeApiKeyInput");
  var continueToUploadBtn = $id("continueToUploadBtn");
  var sessionRestoredBanner = $id("sessionRestoredBanner");
  var sessionRestoredUser = $id("sessionRestoredUser");
  var uploadZone = $id("uploadZone");
  var imageInput = $id("imageInput");
  var uploadPreview = $id("uploadPreview");
  var previewImg = $id("previewImg");
  var removeImgBtn = $id("removeImgBtn");
  var smartTextInput = $id("smartTextInput");
  var smartPastePreview = $id("smartPastePreview");
  var smartPasteImg = $id("smartPasteImg");
  var smartPasteRemove = $id("smartPasteRemove");
  var timezoneSelect = $id("timezoneSelect");
  var extractBtn = $id("extractBtn");
  var liteModeCheck = $id("liteModeCheck");
  var taskList = $id("taskList");
  var addTaskBtn = $id("addTaskBtn");
  var reviewActions = $id("reviewActions");
  var extractionLoading = $id("extractionLoading");
  var photoThumbRow = $id("photoThumbRow");
  var photoThumbImg = $id("photoThumbImg");
  var lightboxOverlay = $id("lightboxOverlay");
  var lightboxImg = $id("lightboxImg");
  var lightboxClose = $id("lightboxClose");
  var lightboxWrap = $id("lightboxWrap");
  var backToUploadBtn = $id("backToUploadBtn");
  var syncBtn = $id("syncBtn");
  var syncProgressBar = $id("syncProgressBar");
  var syncStatusText = $id("syncStatusText");
  var syncingCard = $id("syncingCard");
  var syncDoneCard = $id("syncDoneCard");
  var syncDoneText = $id("syncDoneText");
  var newScanBtn = $id("newScanBtn");
  var listModal = $id("listModal");
  var listSelectPriority = $id("listSelectPriority");
  var newListInputPriority = $id("newListInputPriority");
  var listSelectOther = $id("listSelectOther");
  var newListInputOther = $id("newListInputOther");
  var listSelectEvent = $id("listSelectEvent");
  var newListInputEvent = $id("newListInputEvent");
  var modalPrioritySection = $id("modalPrioritySection");
  var modalOtherSection = $id("modalOtherSection");
  var modalEventSection = $id("modalEventSection");
  var modalPriorityLabel = $id("modalPriorityLabel");
  var modalOtherLabel = $id("modalOtherLabel");
  var modalEventLabel = $id("modalEventLabel");
  var listModalCancel = $id("listModalCancel");
  var listModalConfirm = $id("listModalConfirm");
  var logoutBtn = $id("logoutBtn");
  var userName = $id("userName");
  var userAvatar = $id("userAvatar");
  var tokenExpiryBadge = $id("tokenExpiryBadge");
  var syncDoneIcon = $id("syncDoneIcon");
  var syncDoneTitle = $id("syncDoneTitle");
  var syncErrorDetail = $id("syncErrorDetail");
  var reAuthBtn = $id("reAuthBtn");
  var retryFailedBtn = $id("retryFailedBtn");

  // ========== MSAL SCOPES ==========
  var MSAL_SCOPES = ["Tasks.ReadWrite", "User.Read"];

  // ========== TOAST ==========
  function showToast(msg, type) {
    type = type || "info";
    var tc = $id("toastContainer");
    var t = document.createElement("div");
    t.className = "toast " + type;
    t.textContent = msg;
    tc.appendChild(t);
    setTimeout(function() {
      t.style.opacity = "0";
      t.style.transition = "opacity 0.3s";
      setTimeout(function() { t.remove(); }, 300);
    }, 4000);
  }

  // ========== STEPPER ==========
  function updateStepper(step) {
    state.currentStep = step;
    var items = document.querySelectorAll(".step-item");
    var connectors = document.querySelectorAll(".step-connector");
    items.forEach(function(el, i) {
      var s = i + 1;
      el.classList.remove("active", "completed");
      if (s < step) { el.classList.add("completed"); }
      else if (s === step) { el.classList.add("active"); }
    });
    connectors.forEach(function(el, i) {
      el.classList.toggle("done", i + 1 < step);
    });
  }

  function showSection(name) {
    document.querySelectorAll(".section").forEach(function(el) {
      el.classList.remove("visible");
    });
    $id("section-" + name).classList.add("visible");
  }

  // ========== INSTRUCTIONS TOGGLE ==========
  instrToggle.addEventListener("click", function() {
    instrToggle.classList.toggle("expanded");
    instrBody.classList.toggle("show");
  });

  // ========== GRAPH API ERROR PARSER ==========
  async function parseGraphError(resp) {
    var status = resp.status;
    var detail = { status: status, code: "", message: "", isAuthError: false };
    try {
      var body = await resp.json();
      if (body.error) {
        detail.code = body.error.code || "";
        detail.message = body.error.message || "";
      }
    } catch(ignored) { /* no JSON body */ }

    if (status === 401) {
      detail.isAuthError = true;
      if (!detail.message) {
        detail.message = "Access token is invalid, expired, or missing required permissions.";
      }
    } else if (status === 403) {
      detail.isAuthError = true;
      if (!detail.message) {
        detail.message = "Insufficient permissions. The Tasks.ReadWrite scope may not be consented.";
      }
    }
    return detail;
  }

  function formatGraphError(detail) {
    var parts = ["HTTP " + detail.status];
    if (detail.code) { parts.push(detail.code); }
    if (detail.message) { parts.push(detail.message); }
    return parts.join(" — ");
  }

  function buildErrorGuidanceHtml(detail) {
    var html = '<div class="error-detail">';
    html += "<strong><i class='fas fa-circle-exclamation'></i> " + (detail.isAuthError ? "Authentication Error" : "API Error") + "</strong>";
    html += "HTTP " + detail.status;
    if (detail.code) { html += " &middot; <code>" + escapeHtml(detail.code) + "</code>"; }
    if (detail.message) { html += "<br>" + escapeHtml(detail.message); }

    if (detail.status === 401) {
      html += "<br><br><strong>Likely causes:</strong><br>";
      html += "&bull; Access token has <strong>expired</strong> (~1 hour lifetime)<br>";
      html += "&bull; <code>Tasks.ReadWrite</code> permission was not consented during sign-in<br>";
      html += "&bull; If using Graph Explorer token, ensure the scope is checked<br>";
      html += '<br>Fix: click <strong>Re-authenticate</strong> below and re-consent permissions.';
    } else if (detail.status === 403) {
      html += "<br><br><strong>Likely cause:</strong> The <code>Tasks.ReadWrite</code> delegated permission is not configured or not admin-consented in your Azure AD app.";
    }
    html += "</div>";
    return html;
  }

  // ========== SESSION STATUS TRACKING ==========
  function startTokenExpiryTracker() {
    stopTokenExpiryTracker();
    updateExpiryBadge();
    state.expiryTimerId = setInterval(updateExpiryBadge, 30000);
  }

  function stopTokenExpiryTracker() {
    if (state.expiryTimerId) {
      clearInterval(state.expiryTimerId);
      state.expiryTimerId = null;
    }
    tokenExpiryBadge.style.display = "none";
  }

  function updateExpiryBadge() {
    // MSAL handles token refresh silently via refresh tokens (up to 90 days).
    // The access token expires every ~60 min, but MSAL renews it automatically.
    // So we show session status, not an access token countdown.
    if (!state.msalInstance) {
      tokenExpiryBadge.style.display = "none";
      return;
    }
    var accounts = state.msalInstance.getAllAccounts();
    if (accounts.length === 0) {
      tokenExpiryBadge.style.display = "none";
      return;
    }
    tokenExpiryBadge.style.display = "";
    tokenExpiryBadge.className = "token-expiry ok";
    tokenExpiryBadge.textContent = "Session active";
  }

  // ========== MSAL INITIALIZATION ==========
  function createMsalInstance(clientId) {
    var msalConfig = {
      auth: {
        clientId: clientId,
        authority: "https://login.microsoftonline.com/common",
        redirectUri: window.location.origin + window.location.pathname
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
      }
    };
    return new msal.PublicClientApplication(msalConfig);
  }

  // ========== ACQUIRE TOKEN (SILENT WITH POPUP FALLBACK) ==========
  async function getAccessToken() {
    if (!state.msalInstance) {
      throw new Error("Not authenticated. Please sign in first.");
    }
    var accounts = state.msalInstance.getAllAccounts();
    if (accounts.length === 0) {
      throw new Error("No active session. Please sign in again.");
    }
    var request = {
      scopes: MSAL_SCOPES,
      account: accounts[0]
    };
    try {
      var response = await state.msalInstance.acquireTokenSilent(request);
      state.accessToken = response.accessToken;
      state.tokenExpiresAt = response.expiresOn ? response.expiresOn.getTime() : (Date.now() + 3600000);
      updateExpiryBadge();
      return response.accessToken;
    } catch(silentErr) {
      // Silent failed — try popup
      try {
        var popupResponse = await state.msalInstance.acquireTokenPopup(request);
        state.accessToken = popupResponse.accessToken;
        state.tokenExpiresAt = popupResponse.expiresOn ? popupResponse.expiresOn.getTime() : (Date.now() + 3600000);
        updateExpiryBadge();
        return popupResponse.accessToken;
      } catch(popupErr) {
        throw new Error("Could not acquire token: " + (popupErr.message || String(popupErr)));
      }
    }
  }

  // ========== LOCALSTORAGE HELPERS ==========
  // Access storage indirectly (self-hosted environment supports it)
  var appStorage = window["localStorage"];

  function loadSavedSettings() {
    try {
      if (!appStorage) { return; }
      var savedClientId = appStorage.getItem("tasksnap_clientId");
      if (savedClientId) { clientIdInput.value = savedClientId; }
    } catch(ignored) { /* storage might not be available */ }
  }

  function saveSettings() {
    try {
      if (!appStorage) { return; }
      appStorage.setItem("tasksnap_clientId", clientIdInput.value.trim());
    } catch(ignored) { /* storage might not be available */ }
  }

  // Decrypted Poe API key held in memory (never stored in plain text)
  var decryptedPoeKey = "";

  function getPoeApiKey() {
    // Return decrypted key if available, otherwise fall back to input field
    return decryptedPoeKey || poeApiKeyInput.value.trim();
  }

  // ========== PIN ENCRYPTION (Web Crypto API — all local, no network) ==========
  var STORAGE_KEY_ENCRYPTED = "tasksnap_enckey";

  function hasSavedEncryptedKey() {
    try {
      return appStorage && !!appStorage.getItem(STORAGE_KEY_ENCRYPTED);
    } catch(e) { return false; }
  }

  function clearSavedEncryptedKey() {
    try {
      if (appStorage) { appStorage.removeItem(STORAGE_KEY_ENCRYPTED); }
    } catch(e) { /* ignore */ }
  }

  async function deriveKey(pin, salt) {
    var enc = new TextEncoder();
    var keyMaterial = await crypto.subtle.importKey(
      "raw", enc.encode(pin), "PBKDF2", false, ["deriveKey"]
    );
    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
      keyMaterial,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );
  }

  async function encryptAndStore(apiKey, pin) {
    var enc = new TextEncoder();
    var salt = crypto.getRandomValues(new Uint8Array(16));
    var iv = crypto.getRandomValues(new Uint8Array(12));
    var key = await deriveKey(pin, salt);
    var ciphertext = await crypto.subtle.encrypt(
      { name: "AES-GCM", iv: iv }, key, enc.encode(apiKey)
    );
    var data = {
      s: btoa(String.fromCharCode.apply(null, salt)),
      i: btoa(String.fromCharCode.apply(null, iv)),
      c: btoa(String.fromCharCode.apply(null, new Uint8Array(ciphertext)))
    };
    appStorage.setItem(STORAGE_KEY_ENCRYPTED, JSON.stringify(data));
  }

  function b64ToUint8(b64) {
    var bin = atob(b64);
    var arr = new Uint8Array(bin.length);
    for (var j = 0; j < bin.length; j++) { arr[j] = bin.charCodeAt(j); }
    return arr;
  }

  async function decryptWithPin(pin) {
    var raw = appStorage.getItem(STORAGE_KEY_ENCRYPTED);
    if (!raw) { throw new Error("No saved key"); }
    var data = JSON.parse(raw);
    var salt = b64ToUint8(data.s);
    var iv = b64ToUint8(data.i);
    var ciphertext = b64ToUint8(data.c);
    var key = await deriveKey(pin, salt);
    var decrypted = await crypto.subtle.decrypt(
      { name: "AES-GCM", iv: iv }, key, ciphertext
    );
    return new TextDecoder().decode(decrypted);
  }

  // ========== PIN UI STATE MANAGEMENT ==========
  var pinStateA = $id("pinStateA");
  var pinStateB = $id("pinStateB");
  var pinStateADesc = $id("pinStateADesc");
  var pinSetInput = $id("pinSetInput");
  var pinConfirmInput = $id("pinConfirmInput");
  var pinSetError = $id("pinSetError");
  var pinUnlockInput = $id("pinUnlockInput");
  var pinUnlockError = $id("pinUnlockError");
  var forgotPinBtn = $id("forgotPinBtn");
  var changeApiKeyBtn = $id("changeApiKeyBtn");
  var pinStateACancel = $id("pinStateACancel");
  var pinCancelChangeBtn = $id("pinCancelChangeBtn");

  function showPinError(el, msg) {
    el.textContent = msg;
    el.style.display = msg ? "" : "none";
  }

  function switchToPinStateA(isChange) {
    pinStateA.style.display = "";
    pinStateB.style.display = "none";
    poeApiKeyInput.value = "";
    if (pinSetInput._autoMask) { pinSetInput._autoMask.clear(); } else { pinSetInput.value = ""; }
    if (pinConfirmInput._autoMask) { pinConfirmInput._autoMask.clear(); } else { pinConfirmInput.value = ""; }
    showPinError(pinSetError, "");
    if (isChange) {
      pinStateADesc.innerHTML = "Enter a new API key and set a new PIN.";
      pinStateACancel.style.display = "";
    } else {
      pinStateADesc.innerHTML = 'Used for AI-powered task extraction. Get your key from <a href="https://poe.com/api_key" target="_blank" rel="noopener"><strong>poe.com/api_key</strong></a>.';
      pinStateACancel.style.display = "none";
    }
  }

  function switchToPinStateB() {
    pinStateA.style.display = "none";
    pinStateB.style.display = "";
    if (pinUnlockInput._autoMask) { pinUnlockInput._autoMask.clear(); } else { pinUnlockInput.value = ""; }
    showPinError(pinUnlockError, "");
  }

  // Validate PIN: exactly 6 alphanumeric characters
  function isValidPin(pin) {
    return /^[a-zA-Z0-9]{6}$/.test(pin);
  }

  // ========== AUTO-MASK INPUT BEHAVIOUR ==========
  // Each character visible for 500ms then masked with ●
  // Show/hide toggle overrides: shows full text or re-enables masking
  var autoMaskTimers = {};

  function setupAutoMaskInput(input) {
    var realValue = "";
    var showFull = false;
    var timerId = null;

    function renderMasked() {
      if (showFull) {
        input.value = realValue;
      } else if (realValue.length === 0) {
        input.value = "";
      } else {
        // All masked
        input.value = "●".repeat(realValue.length);
      }
    }

    function renderLastVisible() {
      if (realValue.length <= 1) {
        input.value = realValue;
      } else {
        input.value = "●".repeat(realValue.length - 1) + realValue.charAt(realValue.length - 1);
      }
    }

    input.addEventListener("input", function(e) {
      if (showFull) {
        // In show mode, input value IS the real value
        realValue = input.value;
        return;
      }

      // Calculate what changed
      var cursorPos = input.selectionStart || 0;
      var rawVal = input.value;
      var oldLen = realValue.length;
      var newLen = rawVal.length;

      if (newLen > oldLen) {
        // Characters added — extract new chars from raw input
        var addedCount = newLen - oldLen;
        var insertPos = cursorPos - addedCount;
        if (insertPos < 0) { insertPos = 0; }
        var added = "";
        for (var k = insertPos; k < insertPos + addedCount; k++) {
          var ch = rawVal.charAt(k);
          if (ch !== "●") { added += ch; }
          else { added += realValue.charAt(k) || ""; }
        }
        realValue = realValue.substring(0, insertPos) + added + realValue.substring(insertPos);
      } else if (newLen < oldLen) {
        // Characters deleted
        var deletedCount = oldLen - newLen;
        var delPos = cursorPos;
        realValue = realValue.substring(0, delPos) + realValue.substring(delPos + deletedCount);
      }

      // Show last char briefly
      if (timerId) { clearTimeout(timerId); }
      renderLastVisible();
      var savedPos = cursorPos;
      timerId = setTimeout(function() {
        renderMasked();
        // Try to restore cursor
        try { input.setSelectionRange(savedPos, savedPos); } catch(ignored) {}
        timerId = null;
      }, 500);
    });

    // Expose controls for the toggle button
    input._autoMask = {
      getRealValue: function() { return realValue; },
      setRealValue: function(v) { realValue = v; renderMasked(); },
      toggleShow: function(show) {
        showFull = show;
        if (timerId) { clearTimeout(timerId); timerId = null; }
        if (show) {
          input.value = realValue;
        } else {
          renderMasked();
        }
      },
      isShowFull: function() { return showFull; },
      clear: function() {
        realValue = "";
        showFull = false;
        if (timerId) { clearTimeout(timerId); timerId = null; }
        input.value = "";
      }
    };
  }

  // Setup auto-mask on all PIN inputs
  setupAutoMaskInput(pinSetInput);
  setupAutoMaskInput(pinConfirmInput);
  setupAutoMaskInput(pinUnlockInput);

  // ========== TOGGLE BUTTONS (show/hide for all pin-toggle-btn) ==========
  document.querySelectorAll(".pin-toggle-btn").forEach(function(btn) {
    btn.addEventListener("click", function() {
      var targetId = btn.getAttribute("data-target");
      var targetInput = $id(targetId);
      if (!targetInput) { return; }
      var icon = btn.querySelector("i");

      if (targetInput._autoMask) {
        // Auto-mask input
        var newShow = !targetInput._autoMask.isShowFull();
        targetInput._autoMask.toggleShow(newShow);
        icon.className = newShow ? "fas fa-eye-slash" : "fas fa-eye";
      } else {
        // Regular password input (API key field)
        var isPwd = targetInput.type === "password";
        targetInput.type = isPwd ? "text" : "password";
        icon.className = isPwd ? "fas fa-eye-slash" : "fas fa-eye";
      }
    });
  });

  // ========== FORGOT PIN / CHANGE API KEY ==========
  function showConfirmDialog(message, onConfirm) {
    var overlay = document.createElement("div");
    overlay.className = "confirm-overlay";
    overlay.innerHTML =
      '<div class="confirm-box">' +
      '<p>' + message + '</p>' +
      '<div class="confirm-actions">' +
      '<button class="btn btn-outline btn-sm" data-action="cancel">Cancel</button>' +
      '<button class="btn btn-primary btn-sm" data-action="confirm">Confirm</button>' +
      '</div></div>';
    document.body.appendChild(overlay);
    overlay.querySelector('[data-action="cancel"]').addEventListener("click", function() {
      overlay.remove();
    });
    overlay.querySelector('[data-action="confirm"]').addEventListener("click", function() {
      overlay.remove();
      onConfirm();
    });
    overlay.addEventListener("click", function(e) {
      if (e.target === overlay) { overlay.remove(); }
    });
  }

  forgotPinBtn.addEventListener("click", function() {
    showConfirmDialog(
      "This will clear your saved key. You&rsquo;ll need to enter the full API key again and set a new PIN.",
      function() {
        clearSavedEncryptedKey();
        decryptedPoeKey = "";
        switchToPinStateA(false);
        showToast("Saved key cleared. Enter your API key and set a new PIN.", "info");
      }
    );
  });

  changeApiKeyBtn.addEventListener("click", function() {
    switchToPinStateA(true);
  });

  pinCancelChangeBtn.addEventListener("click", function() {
    switchToPinStateB();
  });

  // ========== PIN VALIDATION HELPERS ==========
  // Validate State A (API key + PIN setup) and encrypt
  async function validateAndEncryptStateA() {
    var apiKey = poeApiKeyInput.value.trim();
    if (!apiKey) {
      showToast("Please enter your Poe API key", "error");
      return false;
    }
    var pin = pinSetInput._autoMask.getRealValue();
    var confirmPin = pinConfirmInput._autoMask.getRealValue();

    if (!pin || !confirmPin) {
      showPinError(pinSetError, "Please enter and confirm your PIN.");
      return false;
    }
    if (!isValidPin(pin)) {
      showPinError(pinSetError, "PIN must be exactly 6 alphanumeric characters.");
      return false;
    }
    if (pin !== confirmPin) {
      showPinError(pinSetError, "PINs do not match.");
      return false;
    }
    showPinError(pinSetError, "");

    try {
      await encryptAndStore(apiKey, pin);
      decryptedPoeKey = apiKey;
      return true;
    } catch(err) {
      showPinError(pinSetError, "Encryption failed: " + err.message);
      return false;
    }
  }

  // Validate State B (PIN unlock) and decrypt
  async function validateAndDecryptStateB() {
    var pin = pinUnlockInput._autoMask.getRealValue();
    if (!pin) {
      showPinError(pinUnlockError, "Please enter your PIN.");
      return false;
    }
    if (!isValidPin(pin)) {
      showPinError(pinUnlockError, "PIN must be exactly 6 alphanumeric characters.");
      return false;
    }
    showPinError(pinUnlockError, "");

    try {
      var key = await decryptWithPin(pin);
      decryptedPoeKey = key;
      return true;
    } catch(err) {
      showPinError(pinUnlockError, "Wrong PIN. Please try again.");
      return false;
    }
  }

  // Determine initial PIN state
  function initPinState() {
    if (hasSavedEncryptedKey()) {
      switchToPinStateB();
    } else {
      switchToPinStateA(false);
    }
  }

  // ========== MSAL LOGIN HANDLER ==========
  function showMsalStatus(msg, isError) {
    msalStatusMsg.style.display = "";
    msalStatusMsg.textContent = msg;
    msalStatusMsg.style.color = isError ? "var(--danger)" : "var(--text-secondary)";
  }

  function hideMsalStatus() {
    msalStatusMsg.style.display = "none";
    msalStatusMsg.textContent = "";
  }

  msalLoginBtn.addEventListener("click", async function() {
    var clientId = clientIdInput.value.trim();
    if (!clientId) {
      showToast("Please enter your Application (Client) ID", "error");
      return;
    }

    // Handle PIN state: State A (setup) or State B (unlock)
    if (pinStateB.style.display !== "none") {
      // State B: PIN unlock
      var unlockOk = await validateAndDecryptStateB();
      if (!unlockOk) { return; }
    } else {
      // State A: Full key + PIN setup
      var setupOk = await validateAndEncryptStateA();
      if (!setupOk) { return; }
    }

    // Save settings
    saveSettings();

    msalLoginBtn.disabled = true;
    showMsalStatus("Initializing…", false);

    try {
      state.msalInstance = createMsalInstance(clientId);
      await state.msalInstance.initialize();

      showMsalStatus("Opening sign-in popup…", false);
      var loginResponse = await state.msalInstance.loginPopup({
        scopes: MSAL_SCOPES
      });

      state.accessToken = loginResponse.accessToken;
      state.tokenExpiresAt = loginResponse.expiresOn ? loginResponse.expiresOn.getTime() : (Date.now() + 3600000);

      // Fetch user info
      showMsalStatus("Fetching account info…", false);
      await fetchUserInfo();

      startTokenExpiryTracker();
      hideMsalStatus();
      updateStepper(2);
      showSection("upload");

      var displayName = state.userInfo ? (state.userInfo.displayName || state.userInfo.mail || "User") : "User";
      showToast("Signed in as " + displayName, "success");
    } catch(err) {
      var errMsg = err.message || String(err);
      if (errMsg.indexOf("user_cancelled") !== -1 || errMsg.indexOf("User cancelled") !== -1) {
        showMsalStatus("Sign-in cancelled", false);
      } else {
        showMsalStatus("Sign-in failed: " + errMsg, true);
        showToast("Sign-in error: " + errMsg, "error");
      }
      state.msalInstance = null;
    } finally {
      msalLoginBtn.disabled = false;
    }
  });

  // ========== CONTINUE BUTTON (after session restored) ==========
  continueToUploadBtn.addEventListener("click", async function() {
    // Handle PIN state: State A (setup) or State B (unlock)
    if (pinStateB.style.display !== "none") {
      var unlockOk = await validateAndDecryptStateB();
      if (!unlockOk) { return; }
    } else {
      var setupOk = await validateAndEncryptStateA();
      if (!setupOk) { return; }
    }
    updateStepper(2);
    showSection("upload");
  });

  // ========== AUTO-LOGIN ON PAGE LOAD ==========
  async function tryAutoLogin() {
    loadSavedSettings();
    initPinState(); // Show State A or B based on whether encrypted key exists
    var clientId = clientIdInput.value.trim();
    if (!clientId) { return; }

    try {
      state.msalInstance = createMsalInstance(clientId);
      await state.msalInstance.initialize();

      var accounts = state.msalInstance.getAllAccounts();
      if (accounts.length === 0) {
        state.msalInstance = null;
        return;
      }

      showMsalStatus("Restoring session…", false);

      // Try silent token acquisition
      var response = await state.msalInstance.acquireTokenSilent({
        scopes: MSAL_SCOPES,
        account: accounts[0]
      });

      state.accessToken = response.accessToken;
      state.tokenExpiresAt = response.expiresOn ? response.expiresOn.getTime() : (Date.now() + 3600000);

      await fetchUserInfo();

      startTokenExpiryTracker();
      hideMsalStatus();

      var displayName = state.userInfo ? (state.userInfo.displayName || state.userInfo.mail || "User") : "User";

      // Microsoft session restored — stay on auth page for PIN/key entry
      // Hide the Microsoft card, show session restored banner, show continue button
      msalCard.style.display = "none";
      sessionRestoredBanner.style.display = "";
      continueToUploadBtn.style.display = "";

      if (hasSavedEncryptedKey()) {
        sessionRestoredUser.textContent = "Signed in as " + displayName + " — enter your PIN to continue.";
        showToast("Welcome back, " + displayName + ". Enter your PIN to unlock.", "success");
      } else {
        sessionRestoredUser.textContent = "Signed in as " + displayName + " — enter your Poe API key below to continue.";
        showToast("Welcome back, " + displayName + ". Please enter your Poe API key.", "success");
      }
    } catch(err) {
      hideMsalStatus();
      state.msalInstance = null;
      // Silent failed — user needs to log in again, stay on auth screen
    }
  }

  // ========== USER INFO ==========
  async function fetchUserInfo() {
    try {
      var token = state.accessToken;
      if (state.msalInstance) {
        try { token = await getAccessToken(); } catch(ignored) { /* use existing */ }
      }
      var resp = await fetch("https://graph.microsoft.com/v1.0/me", {
        headers: { Authorization: "Bearer " + token }
      });
      if (resp.ok) {
        state.userInfo = await resp.json();
        var displayName = state.userInfo.displayName || state.userInfo.mail || "User";
        userName.textContent = displayName;
        userAvatar.textContent = displayName.charAt(0).toUpperCase();
      }
    } catch(ignored) {
      userName.textContent = "Signed in";
      userAvatar.textContent = "✓";
    }
  }

  // ========== LOGOUT ==========
  logoutBtn.addEventListener("click", async function() {
    if (state.msalInstance) {
      try {
        var accounts = state.msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          await state.msalInstance.logoutPopup({ account: accounts[0] });
        }
      } catch(ignored) { /* logout popup may be cancelled */ }
    }
    state.accessToken = "";
    state.tokenExpiresAt = 0;
    state.userInfo = null;
    state.tasks = [];
    state.uploadedFile = null;
    state.msalInstance = null;
    decryptedPoeKey = "";
    stopTokenExpiryTracker();
    // Restore auth section to default state
    msalCard.style.display = "";
    sessionRestoredBanner.style.display = "none";
    continueToUploadBtn.style.display = "none";
    initPinState();
    updateStepper(1);
    showSection("auth");
    showToast("Signed out", "info");
  });

  // ========== TIMEZONE PICKER ==========
  function populateTimezones() {
    var common = [
      "UTC",
      "America/New_York", "America/Chicago", "America/Denver",
      "America/Los_Angeles", "America/Anchorage", "Pacific/Honolulu",
      "Europe/London", "Europe/Paris", "Europe/Berlin",
      "Europe/Moscow", "Asia/Dubai", "Asia/Kolkata",
      "Asia/Shanghai", "Asia/Tokyo", "Asia/Seoul",
      "Australia/Sydney", "Pacific/Auckland"
    ];
    var guess = "";
    try { guess = Intl.DateTimeFormat().resolvedOptions().timeZone; } catch(ignored) { /* no-op */ }

    timezoneSelect.innerHTML = "";
    common.forEach(function(tz) {
      var opt = document.createElement("option");
      opt.value = tz;
      opt.textContent = tz.replace(/_/g, " ");
      if (tz === guess) { opt.selected = true; }
      timezoneSelect.appendChild(opt);
    });

    if (guess && common.indexOf(guess) === -1) {
      var opt = document.createElement("option");
      opt.value = guess;
      opt.textContent = guess.replace(/_/g, " ") + " (detected)";
      opt.selected = true;
      timezoneSelect.insertBefore(opt, timezoneSelect.firstChild);
    }
  }
  populateTimezones();

  // ========== IMAGE UPLOAD ==========
  uploadZone.addEventListener("click", function() { imageInput.click(); });

  uploadZone.addEventListener("dragover", function(e) {
    e.preventDefault();
    uploadZone.classList.add("dragover");
  });
  uploadZone.addEventListener("dragleave", function() {
    uploadZone.classList.remove("dragover");
  });
  uploadZone.addEventListener("drop", function(e) {
    e.preventDefault();
    uploadZone.classList.remove("dragover");
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleImageFile(e.dataTransfer.files[0]);
    }
  });

  imageInput.addEventListener("change", function() {
    if (imageInput.files && imageInput.files[0]) {
      handleImageFile(imageInput.files[0]);
    }
  });

  function handleImageFile(file) {
    if (!file.type.startsWith("image/")) {
      showToast("Please upload an image file", "error");
      return;
    }
    if (file.size > 20 * 1024 * 1024) {
      showToast("File too large. Max 20 MB", "error");
      return;
    }
    state.uploadedFile = file;
    var reader = new FileReader();
    reader.onload = function(e) {
      state.photoDataUrl = e.target.result;
      previewImg.src = e.target.result;
      uploadPreview.style.display = "block";
      uploadZone.style.display = "none";
      updateExtractBtnState();
    };
    reader.readAsDataURL(file);
  }

  removeImgBtn.addEventListener("click", function() {
    state.uploadedFile = null;
    state.photoDataUrl = null;
    previewImg.src = "";
    uploadPreview.style.display = "none";
    uploadZone.style.display = "";
    imageInput.value = "";
    updateExtractBtnState();
  });

  // ========== SMART INPUT (text + paste image) ==========
  // State for pasted image (separate from uploaded photo)
  var smartPasteDataUrl = null;

  function updateExtractBtnState() {
    // Enable if there's a photo, a pasted image, or text
    var hasPhoto = !!state.uploadedFile;
    var hasPaste = !!smartPasteDataUrl;
    var hasText = smartTextInput.value.trim().length > 0;
    extractBtn.disabled = !(hasPhoto || hasPaste || hasText);
  }

  smartTextInput.addEventListener("input", updateExtractBtnState);

  // Handle paste events on the textarea
  smartTextInput.addEventListener("paste", function(e) {
    var items = e.clipboardData && e.clipboardData.items;
    if (!items) { return; }
    for (var i = 0; i < items.length; i++) {
      if (items[i].type.indexOf("image") !== -1) {
        e.preventDefault();
        var file = items[i].getAsFile();
        if (!file) { continue; }
        var reader = new FileReader();
        reader.onload = function(ev) {
          smartPasteDataUrl = ev.target.result;
          smartPasteImg.src = ev.target.result;
          smartPastePreview.style.display = "";
          // If no photo uploaded yet, also use pasted image as the main photo
          if (!state.uploadedFile) {
            state.uploadedFile = file;
            state.photoDataUrl = ev.target.result;
            previewImg.src = ev.target.result;
            uploadPreview.style.display = "block";
            uploadZone.style.display = "none";
          }
          updateExtractBtnState();
        };
        reader.readAsDataURL(file);
        break; // Only handle first image
      }
    }
  });

  smartPasteRemove.addEventListener("click", function() {
    // If the pasted image was also used as the main photo, clear that too
    if (smartPasteDataUrl && state.photoDataUrl === smartPasteDataUrl) {
      state.uploadedFile = null;
      state.photoDataUrl = null;
      previewImg.src = "";
      uploadPreview.style.display = "none";
      uploadZone.style.display = "";
      imageInput.value = "";
    }
    smartPasteDataUrl = null;
    smartPasteImg.src = "";
    smartPastePreview.style.display = "none";
    updateExtractBtnState();
  });

  // ========== DATE HELPERS ==========
  function getNextBusinessDay(dateStr) {
    // dateStr is "YYYY-MM-DD"
    var parts = dateStr.split("-");
    var d = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
    // Move to next day first
    d.setDate(d.getDate() + 1);
    // Skip weekends: 0=Sun, 6=Sat
    var day = d.getDay();
    if (day === 6) { d.setDate(d.getDate() + 2); } // Sat → Mon
    else if (day === 0) { d.setDate(d.getDate() + 1); } // Sun → Mon
    var yyyy = d.getFullYear();
    var mm = String(d.getMonth() + 1).padStart(2, "0");
    var dd = String(d.getDate()).padStart(2, "0");
    return yyyy + "-" + mm + "-" + dd;
  }

  function normalizeDateTimeForGraph(dt) {
    // Ensures format: YYYY-MM-DDTHH:mm:ss.0000000
    if (!dt) { return null; }
    // Remove any trailing Z or timezone offset
    var clean = dt.replace(/Z$/, "").replace(/[+-]\d{2}:\d{2}$/, "");
    // Split on T
    var tIdx = clean.indexOf("T");
    var datePart, timePart;
    if (tIdx !== -1) {
      datePart = clean.substring(0, tIdx);
      timePart = clean.substring(tIdx + 1);
    } else {
      datePart = clean;
      timePart = "09:00:00";
    }
    // Validate date part
    if (!/^\d{4}-\d{2}-\d{2}$/.test(datePart)) { return null; }
    // Normalize time part to HH:mm:ss
    var timeParts = timePart.split(":");
    var hh = (timeParts[0] || "09").padStart(2, "0");
    var mi = (timeParts[1] || "00").padStart(2, "0");
    var ss = (timeParts[2] || "00").padStart(2, "0").substring(0, 2);
    return datePart + "T" + hh + ":" + mi + ":" + ss + ".0000000";
  }

  // ========== LIGHTBOX ==========
  var lbZoom = 1;

  function applyZoom() {
    lightboxImg.style.transform = "scale(" + lbZoom + ")";
    if (lbZoom > 1) {
      lightboxImg.classList.add("zoomed");
      lightboxWrap.style.alignItems = "flex-start";
      lightboxWrap.style.justifyContent = "flex-start";
    } else {
      lightboxImg.classList.remove("zoomed");
      lightboxWrap.style.alignItems = "center";
      lightboxWrap.style.justifyContent = "center";
    }
  }

  function openLightbox() {
    if (!state.photoDataUrl) { return; }
    lightboxImg.src = state.photoDataUrl;
    lbZoom = 1;
    applyZoom();
    lightboxOverlay.classList.add("open");
  }
  function closeLightbox() {
    lightboxOverlay.classList.remove("open");
    lightboxImg.src = "";
    lbZoom = 1;
    applyZoom();
  }
  photoThumbRow.addEventListener("click", openLightbox);
  lightboxClose.addEventListener("click", closeLightbox);
  lightboxOverlay.addEventListener("click", function(e) {
    if (e.target === lightboxOverlay || e.target === lightboxWrap) { closeLightbox(); }
  });
  lightboxWrap.addEventListener("dblclick", function(e) {
    e.preventDefault();
    if (lbZoom >= 3) { lbZoom = 1; } else { lbZoom = Math.min(lbZoom + 1, 4); }
    applyZoom();
  });
  lightboxWrap.addEventListener("wheel", function(e) {
    e.preventDefault();
    lbZoom = Math.max(0.5, Math.min(4, lbZoom + (e.deltaY < 0 ? 0.3 : -0.3)));
    applyZoom();
  }, { passive: false });

  function showPhotoThumbnail() {
    if (state.photoDataUrl) {
      photoThumbImg.src = state.photoDataUrl;
      photoThumbRow.style.display = "";
    } else {
      photoThumbRow.style.display = "none";
    }
  }

  // ========== PRIORITY DETECTION ==========
  var PRIORITY_KEYWORDS = [
    "quiz", "exam", "test", "assessment",
    "測", "小測", "測驗", "考", "考試", "口試",
    "dict", "dictation", "默", "默書"
  ];

  function isPriorityTask(title, body) {
    var combined = ((title || "") + " " + (body || "")).toLowerCase();
    for (var k = 0; k < PRIORITY_KEYWORDS.length; k++) {
      if (combined.indexOf(PRIORITY_KEYWORDS[k].toLowerCase()) !== -1) {
        return true;
      }
    }
    return false;
  }

  // ========== EXTRACT TASKS WITH LLM ==========
  // Store user instruction text for later inclusion in task notes
  var lastUserInstruction = "";
  // Track input mode at extraction time for Lite Mode decisions
  var lastInputHadText = false;
  // Cache of user's To Do list names for AI prompt (fetched fresh each extraction)
  var cachedListNames = [];

  // Fetch user's To Do lists fresh before each extraction
  async function fetchListNamesForPrompt() {
    try {
      var token = await getAccessToken();
      var resp = await fetch("https://graph.microsoft.com/v1.0/me/todo/lists", {
        headers: { Authorization: "Bearer " + token }
      });
      if (!resp.ok) { return []; }
      var data = await resp.json();
      var lists = data.value || [];
      return lists.map(function(l) { return l.displayName; });
    } catch(err) {
      return [];
    }
  }

  extractBtn.addEventListener("click", function() {
    var hasPhoto = !!state.photoDataUrl;
    var userText = smartTextInput.value.trim();
    lastUserInstruction = userText;
    lastInputHadText = !!userText;

    if (!hasPhoto && !userText) {
      showToast("Please upload an image or type a task", "error");
      return;
    }

    if (liteModeCheck.checked) {
      // In lite mode, show sync section with extracting status
      updateStepper(4);
      showSection("sync");
      syncingCard.style.display = "";
      syncDoneCard.style.display = "none";
      syncProgressBar.style.width = "0%";
      syncStatusText.textContent = "Fetching task lists…";
    } else {
      updateStepper(3);
      showSection("review");
      extractionLoading.style.display = "block";
      taskList.innerHTML = "";
      addTaskBtn.style.display = "none";
      reviewActions.style.display = "none";
    }

    // Fetch lists first, then build prompt
    (async function() {
      try {
        cachedListNames = await fetchListNamesForPrompt();
      } catch(ignored) {
        cachedListNames = [];
      }

      if (liteModeCheck.checked) {
        syncStatusText.textContent = "Extracting tasks…";
      }

      buildAndSendPrompt(hasPhoto, userText);
    })();
  });

  function buildAndSendPrompt(hasPhoto, userText) {
    // Build the prompt based on what inputs are provided
    var todayDate = getTodayDate();

    // Build list override instruction block
    var listOverrideBlock = [];
    if (cachedListNames.length > 0) {
      listOverrideBlock = [
        "",
        "=== LIST OVERRIDE ===",
        "The user has the following task lists available: " + JSON.stringify(cachedListNames),
        "",
        "CRITICAL: Only set listOverride when the user EXPLICITLY names or references a specific list using clear list-assignment language. Examples of EXPLICIT list instructions:",
        "- 'english exam (quiz list)' → the parenthetical names a list",
        "- 'put homework in household list' → 'put ... in ... list' pattern",
        "- 'put all exams in quiz list' → explicit bulk assignment",
        "- 'maths homework >> homework' → explicit delimiter syntax",
        "",
        "NEVER set listOverride based on your own inference of which list a task belongs to. If the user just says 'maths assessment next Sunday' without mentioning any list, listOverride MUST be null — even if you think you know which list it should go to. The app handles default list routing automatically based on task priority. Your job is ONLY to detect when the user explicitly asks for a specific list.",
        "",
        "SCOPE ISOLATION: Each task's listOverride must ONLY come from list instructions that directly accompany THAT specific task, OR from a global instruction that uses words like 'all', 'every', 'everything' to indicate it applies to all tasks. Never propagate one task's specific list instruction to other tasks that have no list instruction of their own. For example, if the user writes 'Maths assessment due next Sunday / Register for boating. Put in Summer list', only the boating task gets listOverride — the maths assessment has no list instruction and its listOverride MUST be null.",
        "",
        "When the user DOES explicitly specify a list:",
        "- Match the user's words to the closest list name from the available lists above.",
        "- If the user says something like 'put all in X list' or 'put everything in X', apply the override to ALL tasks/events.",
        "- If the user specifies overrides for some tasks but not others, only set listOverride on the specified tasks. Tasks without explicit list instructions should have listOverride set to null.",
        "- If you cannot confidently match the user's words to any available list, set listOverride to the user's words as-is (e.g. \"work list\").",
        "- The listOverride field should contain the EXACT list name from the available lists when a match is found, or the user's raw words when no match is found.",
        ""
      ];
    }

    // Base vision prompt for images (todo list + event detection + mixed)
    var imagePromptLines = [
      "Analyze this image carefully. Today's date is: " + todayDate,
      "",
      "=== STEP 1: CLASSIFY THE IMAGE ===",
      "Determine if this image is:",
      '- "todo_list": a handwritten or printed list of homework tasks, assignments, or things to do',
      '- "event": an event flier, event poster, event summary email/webpage, registration notice, competition announcement, workshop notice, or similar event information',
      "",
      "IMPORTANT: If the user instruction mentions ADDITIONAL tasks beyond what the image shows (e.g. the image is an event flier but the user also mentions homework or exams), you MUST return ALL items — both from the image AND from the user instruction — using the mixed format described below.",
      "",
      "=== STEP 2: EXTRACT BASED ON TYPE ===",
      "",
      '--- If type is "todo_list" (and no events) ---',
      "",
      "1. PHOTO DATE: Look at the top-left area of the image for a date (the photo date / header date). Extract it as photoDate in YYYY-MM-DD format. If no date is found, set photoDate to null.",
      "",
      "2. EXTRACT ALL TASKS visible in the image.",
      "",
      "3. SUBJECT GROUPING: Tasks in the photo are often grouped by subject using abbreviations like M (Maths), E (English), 中 (Chinese), 音 (Music), 人 (Liberal Studies/人文), Sci (Science), etc. When multiple tasks fall under the same subject heading, the subject is written once and sub-tasks are indented with numbers, bullets, or *. You MUST prefix EVERY task title with its subject in square brackets, e.g. \"[Maths] Complete worksheet p.12\" or \"[中文] 默書溫習\". Always include the subject prefix even for the first task under a heading.",
      "",
      "4. PRIORITY DETECTION: For each task, determine if it is a priority task. A task is priority if its title or content relates to any of these keywords (case-insensitive): quiz, exam, test, assessment, 測, 小測, 測驗, 考, 考試, 口試, dict, dictation, 默, 默書. Set \"priority\" to true for these tasks, false otherwise.",
      "",
      "5. DATE PARSING — CRITICAL: Dates in the image may appear in various formats. You MUST convert them accurately to YYYY-MM-DDTHH:mm:ss. Common formats include:",
      "   - Chinese dates: 6月5日, 六月五日, 6/5, 12月20日",
      "   - Shortened numerical: 6/5, 12/20, 5-6, 20/12",
      "   - With year: 2025年6月5日, 2025/6/5",
      "   - Without year: assume the current or next occurrence based on context",
      "   - If only a date is given with no time, default the time to 09:00:00",
      "   - For priority tasks (quiz/exam/test/assessment/dictation), pay EXTRA attention to correctly reading the due date — these dates are critical.",
      "",
      "Return JSON:",
      '{',
      '  "type": "todo_list",',
      '  "photoDate": "YYYY-MM-DD" or null,',
      '  "tasks": [',
      '    {',
      '      "title": "string",',
      '      "body": "string (additional details; empty string if none)",',
      '      "dueDateTime": "YYYY-MM-DDTHH:mm:ss" or null,',
      '      "priority": true or false,',
      '      "listOverride": "exact list name" or null',
      '    }',
      '  ]',
      '}',
      "If a task is already marked as done/completed in the image, still include it but prepend [DONE] to the title.",
      "",
      '--- If type is "event" (and no additional tasks from user instruction) ---',
      "",
      "Extract the following from the event flier/email/webpage:",
      "- eventName: The name/title of the event (e.g. \"Math Olympiad 2026\", \"School Science Fair\")",
      "- registrationDeadline: The deadline/closing date for registration, in YYYY-MM-DD format. Look for phrases like \"register by\", \"deadline\", \"closing date\", \"報名截止\", \"截止日期\". null if not found.",
      "- registrationMethod: How to register — include any URL links, email addresses, QR code mentions, form names, or description of the registration process. Combine all relevant info into one string. Empty string if not found.",
      "- taskDueDateTime: If the user instruction specifies WHEN the task should be due (e.g. 'in two days', 'tonight', 'by Friday'), compute it as YYYY-MM-DDTHH:mm:ss based on today's date. If the user does not specify a due date, set to null (the app will calculate a default).",
      "",
      "Return JSON:",
      '{',
      '  "type": "event",',
      '  "eventName": "string",',
      '  "registrationDeadline": "YYYY-MM-DD" or null,',
      '  "registrationMethod": "string or empty string",',
      '  "taskDueDateTime": "YYYY-MM-DDTHH:mm:ss" or null,',
      '  "listOverride": "exact list name" or null',
      '}',
      "",
      '--- If MIXED (image has an event AND user instruction mentions additional tasks, or vice versa) ---',
      "",
      "When the input contains BOTH event registration items AND regular tasks (e.g. user says 'register for this event, also english exam next Monday and maths homework by 25 Mar'), you MUST return ALL items using this mixed format:",
      "",
      "Return JSON:",
      '{',
      '  "type": "mixed",',
      '  "photoDate": "YYYY-MM-DD" or null,',
      '  "tasks": [',
      '    {',
      '      "title": "string",',
      '      "body": "string (additional details; empty string if none)",',
      '      "dueDateTime": "YYYY-MM-DDTHH:mm:ss" or null,',
      '      "priority": true or false,',
      '      "listOverride": "exact list name" or null',
      '    }',
      '  ],',
      '  "events": [',
      '    {',
      '      "eventName": "string",',
      '      "registrationDeadline": "YYYY-MM-DD" or null,',
      '      "registrationMethod": "string or empty string",',
      '      "taskDueDateTime": "YYYY-MM-DDTHH:mm:ss" or null,',
      '      "listOverride": "exact list name" or null',
      '    }',
      '  ]',
      '}',
      "Apply the same PRIORITY DETECTION and DATE PARSING rules to the tasks array.",
      ""
    ];

    // Append list override block if available
    imagePromptLines = imagePromptLines.concat(listOverrideBlock);
    imagePromptLines.push("=== IMPORTANT ===");
    imagePromptLines.push("Return ONLY a valid JSON object (no other text, no markdown code blocks).");

    // Text-only prompt (no image)
    var textOnlyPromptLines = [
      "The user wants to create tasks based on the following natural language input. Today's date is " + todayDate + ".",
      "",
      "The user may describe MULTIPLE items in a single input. Each item can be either a regular task or an event registration. You MUST extract ALL of them.",
      "",
      "For EACH item, classify it as:",
      "- regular task: homework, assignment, reminder, or thing to do",
      "- event: a request to register for an event, competition, workshop, activity, dinner, etc. (look for keywords like 'register', 'sign up', 'enrol', 'enroll', '報名')",
      "",
      "=== EXTRACTION RULES ===",
      "",
      "For regular tasks:",
      "- Extract a clear task title",
      "- Parse due date/time if mentioned (interpret relative dates like 'tonight' = today 21:00, 'tomorrow' = next day 09:00, 'in two days' = 2 days from today 09:00, 'next Friday' = the coming Friday 09:00, etc.)",
      "- Extract any additional notes/details",
      "- PRIORITY DETECTION: A task is priority if its title or content relates to any of these keywords (case-insensitive): quiz, exam, test, assessment, 測, 小測, 測驗, 考, 考試, 口試, dict, dictation, 默, 默書. Set \"priority\" to true for these tasks, false otherwise.",
      "",
      "For events:",
      "- eventName: The name/title of the event",
      "- registrationDeadline: deadline date in YYYY-MM-DD format, null if not mentioned",
      "- registrationMethod: how to register (URL, email, etc.), empty string if not mentioned",
      "- taskDueDateTime: parse from user input as YYYY-MM-DDTHH:mm:ss, null if not specified",
      "",
      "=== RESPONSE FORMAT ===",
      "",
      "If the input contains ONLY regular tasks (no events):",
      '{',
      '  "type": "text_task",',
      '  "tasks": [',
      '    { "title": "string", "body": "string", "dueDateTime": "YYYY-MM-DDTHH:mm:ss" or null, "priority": true or false, "listOverride": "exact list name" or null }',
      '  ]',
      '}',
      "",
      "If the input contains ONLY event(s) (no regular tasks):",
      '{',
      '  "type": "event",',
      '  "eventName": "string",',
      '  "registrationDeadline": "YYYY-MM-DD" or null,',
      '  "registrationMethod": "string or empty string",',
      '  "taskDueDateTime": "YYYY-MM-DDTHH:mm:ss" or null,',
      '  "listOverride": "exact list name" or null',
      '}',
      "",
      "If the input contains BOTH events AND regular tasks:",
      '{',
      '  "type": "mixed",',
      '  "tasks": [',
      '    { "title": "string", "body": "string", "dueDateTime": "YYYY-MM-DDTHH:mm:ss" or null, "priority": true or false, "listOverride": "exact list name" or null }',
      '  ],',
      '  "events": [',
      '    { "eventName": "string", "registrationDeadline": "YYYY-MM-DD" or null, "registrationMethod": "string or empty string", "taskDueDateTime": "YYYY-MM-DDTHH:mm:ss" or null, "listOverride": "exact list name" or null }',
      '  ]',
      '}',
      ""
    ];

    // Append list override block if available
    textOnlyPromptLines = textOnlyPromptLines.concat(listOverrideBlock);
    textOnlyPromptLines.push("=== IMPORTANT ===");
    textOnlyPromptLines.push("Return ONLY a valid JSON object (no other text, no markdown code blocks).");

    // Determine which prompt and content to send
    var promptText;
    var messageContent;

    if (hasPhoto && userText) {
      // MODE 1: Photo + text instruction
      promptText = imagePromptLines.join("\n") +
        "\n\n=== USER INSTRUCTION ===\n" +
        "The user provided the following instruction alongside the image. Use it as your PRIMARY GUIDE for how to interpret the image and what tasks to create. " +
        "The user's instruction takes priority over the default classification rules above.\n\n" +
        "User says: \"" + userText + "\"";
      messageContent = [
        { type: "text", text: promptText },
        { type: "image_url", image_url: { url: state.photoDataUrl } }
      ];
    } else if (hasPhoto) {
      // MODE 2: Photo only (original behavior)
      promptText = imagePromptLines.join("\n");
      messageContent = [
        { type: "text", text: promptText },
        { type: "image_url", image_url: { url: state.photoDataUrl } }
      ];
    } else {
      // MODE 3: Text only (no image)
      promptText = textOnlyPromptLines.join("\n") + "\n\nUser input: \"" + userText + "\"";
      messageContent = [
        { type: "text", text: promptText }
      ];
    }

    var poeKey = getPoeApiKey();
    if (!poeKey) {
      extractionLoading.style.display = "none";
      showToast("Poe API key is missing. Please go back and enter it.", "error");
      reviewActions.style.display = "flex";
      addTaskBtn.style.display = "";
      return;
    }

    // Call Poe OpenAI-compatible API
    (async function() {
      try {
        var poeResp = await fetch("https://api.poe.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + poeKey,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "GPT-5.2",
            stream: false,
            messages: [
              {
                role: "user",
                content: messageContent
              }
            ]
          })
        });

        if (!poeResp.ok) {
          var errBody = "";
          try { errBody = await poeResp.text(); } catch(ignored) { /* no body */ }
          throw new Error("Poe API error (HTTP " + poeResp.status + "): " + errBody);
        }

        var poeData = await poeResp.json();
        var content = "";
        if (poeData.choices && poeData.choices.length > 0 && poeData.choices[0].message) {
          content = poeData.choices[0].message.content || "";
        }

        if (!content) {
          throw new Error("Empty response from AI");
        }

        processExtractionResult(content);
      } catch(err) {
        showToast("AI extraction failed: " + (err.message || String(err)), "error");
        // Fall back to review section
        updateStepper(3);
        showSection("review");
        extractionLoading.style.display = "none";
        reviewActions.style.display = "flex";
        addTaskBtn.style.display = "";
      }
    })();
  }

  // Helper: get today's date as YYYY-MM-DD in local time
  function getTodayDate() {
    var d = new Date();
    return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
  }

  // Helper: get previous day as YYYY-MM-DD
  function getPreviousDay(dateStr) {
    var parts = dateStr.split("-");
    var d = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
    d.setDate(d.getDate() - 1);
    return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
  }

  function processExtractionResult(content) {
    extractionLoading.style.display = "none";

    // Try to parse JSON from content (handle markdown code blocks)
    var jsonStr = content.trim();
    var match = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
    if (match) {
      jsonStr = match[1].trim();
    }

    // Try to find a JSON object
    var parsed = null;
    try {
      var objStart = jsonStr.indexOf("{");
      var objEnd = jsonStr.lastIndexOf("}");
      if (objStart !== -1 && objEnd !== -1) {
        parsed = JSON.parse(jsonStr.substring(objStart, objEnd + 1));
      }
    } catch(err) {
      parsed = null;
    }

    if (!parsed) {
      showToast("Could not parse AI response. You can add tasks manually.", "error");
      state.tasks = [];
      state.photoDate = null;
      renderPhotoDate();
      renderTasks();
      addTaskBtn.style.display = "";
      reviewActions.style.display = "flex";
      return;
    }

    // ===== PROCESS ALL TYPES: event, todo_list, text_task, mixed =====
    var allTasks = [];
    var idCounter = 0;
    var uploadDate = getTodayDate();

    // --- Helper: build event task objects from an event data object ---
    function buildEventTask(ev) {
      var eventName = (ev.eventName || "Unknown Event").trim();
      var deadline = ev.registrationDeadline || null;
      var regMethod = (ev.registrationMethod || "").trim();
      var dueDateTimeStr;
      var userDue = ev.taskDueDateTime || null;
      if (userDue && /^\d{4}-\d{2}-\d{2}T/.test(userDue)) {
        dueDateTimeStr = userDue;
      } else {
        var dueDate;
        if (deadline && /^\d{4}-\d{2}-\d{2}$/.test(deadline)) {
          dueDate = getPreviousDay(deadline);
        } else {
          dueDate = uploadDate;
        }
        dueDateTimeStr = dueDate + "T21:00:00";
      }
      var dueDateOnly = dueDateTimeStr.substring(0, 10);
      var reminderDateTime = dueDateOnly + "T21:00:00.0000000";
      var bodyParts = [];
      if (regMethod) { bodyParts.push("Registration: " + regMethod); }
      if (deadline) { bodyParts.push("Registration deadline: " + deadline); }
      if (lastUserInstruction) {
        bodyParts.push((bodyParts.length > 0 ? "\n" : "") + "User note: " + lastUserInstruction);
      }
      return {
        id: "task-" + Date.now() + "-" + (idCounter++),
        title: "Register for " + eventName,
        body: bodyParts.join("\n"),
        dueDateTime: dueDateTimeStr,
        priority: false,
        checked: true,
        synced: false,
        isEvent: true,
        reminderDateTime: reminderDateTime,
        listOverride: ev.listOverride || null
      };
    }

    // --- Helper: build regular task objects from a tasks array ---
    function buildRegularTasks(tasksArr, defaultDueDateTime) {
      return tasksArr.map(function(t) {
        var due = t.dueDateTime || null;
        if (!due && defaultDueDateTime) { due = defaultDueDateTime; }
        var titleStr = t.title || "Untitled task";
        var bodyStr = t.body || "";
        // Check priority BEFORE appending user instruction (to avoid false positives
        // from other tasks' keywords appearing in the shared user instruction text)
        var pri = (t.priority === true) || isPriorityTask(titleStr, bodyStr);
        // Append user instruction to body after priority check
        if (lastUserInstruction) {
          bodyStr = (bodyStr ? bodyStr + "\n\n" : "") + "User note: " + lastUserInstruction;
        }
        return {
          id: "task-" + Date.now() + "-" + (idCounter++),
          title: titleStr,
          body: bodyStr,
          dueDateTime: due,
          priority: pri,
          checked: lastInputHadText ? true : pri,
          synced: false,
          listOverride: t.listOverride || null
        };
      });
    }

    // --- Route based on type ---
    if (parsed.type === "mixed") {
      // MIXED: contains both events and regular tasks
      state.photoDate = parsed.photoDate || null;
      var eventsArr = parsed.events || [];
      var regTasksArr = parsed.tasks || [];
      eventsArr.forEach(function(ev) { allTasks.push(buildEventTask(ev)); });
      var defaultDue = null;
      if (state.photoDate && /^\d{4}-\d{2}-\d{2}$/.test(state.photoDate)) {
        defaultDue = getNextBusinessDay(state.photoDate) + "T09:00:00";
      }
      allTasks = allTasks.concat(buildRegularTasks(regTasksArr, defaultDue));

    } else if (parsed.type === "event") {
      // SINGLE EVENT (no regular tasks)
      state.photoDate = null;
      allTasks.push(buildEventTask(parsed));

    } else {
      // TODO_LIST or TEXT_TASK
      var tasksArr = [];
      try {
        if (parsed.tasks && Array.isArray(parsed.tasks)) {
          state.photoDate = parsed.photoDate || null;
          tasksArr = parsed.tasks;
        } else if (Array.isArray(parsed)) {
          tasksArr = parsed;
        } else {
          var arrStart = jsonStr.indexOf("[");
          var arrEnd = jsonStr.lastIndexOf("]");
          if (arrStart !== -1 && arrEnd !== -1) {
            tasksArr = JSON.parse(jsonStr.substring(arrStart, arrEnd + 1));
          }
        }
        if (!Array.isArray(tasksArr)) { throw new Error("Expected tasks array"); }
      } catch(err) {
        showToast("Could not parse AI response. You can add tasks manually.", "error");
        state.tasks = [];
        state.photoDate = null;
        renderPhotoDate();
        renderTasks();
        addTaskBtn.style.display = "";
        reviewActions.style.display = "flex";
        return;
      }
      var defaultDueDateTime = null;
      if (state.photoDate && /^\d{4}-\d{2}-\d{2}$/.test(state.photoDate)) {
        defaultDueDateTime = getNextBusinessDay(state.photoDate) + "T09:00:00";
      }
      allTasks = buildRegularTasks(tasksArr, defaultDueDateTime);
    }

    state.tasks = allTasks;

    showPhotoThumbnail();

    // ===== LITE MODE =====
    if (liteModeCheck.checked) {
      if (lastInputHadText) {
        // Text-only or photo+text: sync ALL tasks to their respective categories
        state.tasks.forEach(function(t) { t.checked = true; });
        var syncCount = state.tasks.filter(function(t) { return t.title.trim(); }).length;
        showToast("Lite mode: syncing " + syncCount + " task" + (syncCount > 1 ? "s" : "") + "…", "success");
        liteModeSync(true);
        return;
      }

      // Photo only
      var priTasks = state.tasks.filter(function(t) { return t.priority; });
      if (priTasks.length === 0) {
        // No priority tasks found — fall back to manual review
        state.tasks.forEach(function(t) { t.checked = true; });
        updateStepper(3);
        showSection("review");
        extractionLoading.style.display = "none";
        showToast("No priority tasks found. Showing full review.", "info");
        renderPhotoDate();
        renderTasks();
        addTaskBtn.style.display = "";
        reviewActions.style.display = "flex";
        return;
      }

      // Photo only with priority tasks: sync priority only
      var priCount = priTasks.length;
      var totalCount = state.tasks.length;
      showToast("Lite mode: " + priCount + " priority task" + (priCount > 1 ? "s" : "") + " of " + totalCount + " total — syncing now…", "success");
      liteModeSync(false);
      return;
    }

    // ===== NORMAL MODE: show review =====
    renderPhotoDate();
    renderTasks();
    if (state.tasks.length > 0) {
      var priCount2 = state.tasks.filter(function(t) { return t.priority; }).length;
      var msg = "Extracted " + state.tasks.length + " task" + (state.tasks.length > 1 ? "s" : "");
      if (priCount2 > 0) {
        msg += " (" + priCount2 + " priority)";
      }
      showToast(msg, "success");
    } else {
      showToast("No tasks found in the image. You can add tasks manually.", "info");
    }

    addTaskBtn.style.display = "";
    reviewActions.style.display = "flex";
  }

  // (Event processing is now handled inline in processExtractionResult via buildEventTask)

  // ========== LITE MODE SYNC ==========
  var LITE_PRIORITY_LIST_NAME = "Theo Quiz and Dictation";
  var LITE_OTHER_LIST_NAME = "Theo Homework";
  var LITE_EVENT_LIST_NAME = "Household Tasks";

  // Helper: find a list by name or create it
  async function findOrCreateList(lists, listName) {
    for (var i = 0; i < lists.length; i++) {
      if (lists[i].displayName.toLowerCase() === listName.toLowerCase()) {
        return lists[i].id;
      }
    }
    // Not found — create it
    syncStatusText.textContent = "Creating \"" + listName + "\" list…";
    var token = await getAccessToken();
    var resp = await fetch("https://graph.microsoft.com/v1.0/me/todo/lists", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ displayName: listName })
    });
    if (!resp.ok) {
      var detail = await parseGraphError(resp);
      throw new Error(formatGraphError(detail));
    }
    var newList = await resp.json();
    return newList.id;
  }

  // syncAll=true: sync ALL checked tasks (priority → priority list, other → other list)
  // syncAll=false: sync only priority tasks (other tasks ignored)
  async function liteModeSync(syncAll) {
    updateStepper(4);
    showSection("sync");
    syncingCard.style.display = "";
    syncDoneCard.style.display = "none";
    syncProgressBar.style.width = "0%";
    syncStatusText.textContent = "Finding task lists…";

    try {
      var token = await getAccessToken();
      var resp = await fetch("https://graph.microsoft.com/v1.0/me/todo/lists", {
        headers: { Authorization: "Bearer " + token }
      });
      if (!resp.ok) {
        var detail = await parseGraphError(resp);
        throw new Error(formatGraphError(detail));
      }
      var data = await resp.json();
      var lists = data.value || [];

      var priorityListId = null;
      var otherListId = null;
      var eventListId = null;
      var overrideListIds = {};
      var listsUsed = []; // Track list names for toast

      // Determine which types of tasks need syncing
      var checkedTasks = state.tasks.filter(function(t) { return t.checked && !t.synced && t.title.trim(); });

      // Separate tasks with overrides from those without
      var tasksWithOverride = checkedTasks.filter(function(t) { return !!t.listOverride; });
      var tasksWithoutOverride = checkedTasks.filter(function(t) { return !t.listOverride; });

      var hasPriority = tasksWithoutOverride.some(function(t) { return t.priority; });
      var hasEvents = tasksWithoutOverride.some(function(t) { return t.isEvent; });
      var hasRegularOther = tasksWithoutOverride.some(function(t) { return !t.priority && !t.isEvent; });

      // Find/create priority list if needed
      if (hasPriority) {
        priorityListId = await findOrCreateList(lists, LITE_PRIORITY_LIST_NAME);
        listsUsed.push(LITE_PRIORITY_LIST_NAME);
      }

      // Find/create lists for non-priority tasks (only in syncAll mode)
      if (syncAll) {
        if (hasEvents) {
          eventListId = await findOrCreateList(lists, LITE_EVENT_LIST_NAME);
          listsUsed.push(LITE_EVENT_LIST_NAME);
          if (!hasRegularOther) { otherListId = eventListId; }
        }
        if (hasRegularOther) {
          otherListId = await findOrCreateList(lists, LITE_OTHER_LIST_NAME);
          listsUsed.push(LITE_OTHER_LIST_NAME);
        }
      }

      // Resolve override list IDs — auto-create via findOrCreateList
      var processedOverrideKeys = {};
      for (var oi = 0; oi < tasksWithOverride.length; oi++) {
        var overrideKey = tasksWithOverride[oi].listOverride.toLowerCase().trim();
        if (processedOverrideKeys[overrideKey]) { continue; }
        processedOverrideKeys[overrideKey] = true;

        var overrideName = tasksWithOverride[oi].listOverride;
        // Try to match against existing lists
        var matchedList = matchListOverride(overrideName, lists);
        var resolvedName = matchedList ? matchedList.displayName : capitalizeFirstLetter(overrideName.trim());
        syncStatusText.textContent = "Preparing \"" + resolvedName + "\" list…";
        var resolvedId = await findOrCreateList(lists, resolvedName);
        overrideListIds[overrideKey] = resolvedId;
        listsUsed.push(resolvedName);
      }

      await executeSyncTasks(priorityListId, otherListId, eventListId, overrideListIds);

      // Show toast with lists used
      if (listsUsed.length > 0) {
        var uniqueLists = [];
        listsUsed.forEach(function(n) {
          if (uniqueLists.indexOf(n) === -1) { uniqueLists.push(n); }
        });
        showToast("Synced to: " + uniqueLists.join(", "), "success");
      }
    } catch(err) {
      showToast("Lite mode sync failed: " + err.message, "error");
      // Fall back to review section
      updateStepper(3);
      showSection("review");
      renderPhotoDate();
      renderTasks();
      addTaskBtn.style.display = "";
      reviewActions.style.display = "flex";
    }
  }

  // ========== RENDER PHOTO DATE ==========
  var photoDateRow = $id("photoDateRow");
  var photoDateInput = $id("photoDateInput");
  var photoDateInfo = $id("photoDateInfo");

  function renderPhotoDate() {
    if (state.photoDate) {
      photoDateRow.style.display = "";
      photoDateInput.value = state.photoDate;
      var nextBiz = getNextBusinessDay(state.photoDate);
      photoDateInfo.textContent = "Tasks without a due date default to next business day: " + nextBiz + " at 09:00";
    } else {
      photoDateRow.style.display = "none";
      photoDateInput.value = "";
      photoDateInfo.textContent = "";
    }
  }

  photoDateInput.addEventListener("change", function() {
    var newVal = this.value;
    if (!newVal) {
      state.photoDate = null;
      photoDateInfo.textContent = "";
      return;
    }
    var oldPhotoDate = state.photoDate;
    state.photoDate = newVal;
    var newNextBiz = getNextBusinessDay(newVal);
    photoDateInfo.textContent = "Tasks without a due date default to next business day: " + newNextBiz + " at 09:00";

    // Recompute default for tasks that had the old default
    var oldDefault = oldPhotoDate ? getNextBusinessDay(oldPhotoDate) + "T09:00:00" : null;
    var newDefault = newNextBiz + "T09:00:00";
    state.tasks.forEach(function(task) {
      if (task.dueDateTime === oldDefault || (!task.dueDateTime && !oldPhotoDate)) {
        task.dueDateTime = newDefault;
      }
    });
    renderTasks();
  });

  // ========== RENDER TASKS ==========
  function renderTaskCard(task, idx, animIdx) {
    var card = document.createElement("div");
    var cls = "task-card";
    if (task.priority) { cls += " priority-task"; }
    if (!task.checked) { cls += " unchecked-task"; }
    card.className = cls;
    card.style.animationDelay = (animIdx * 0.06) + "s";

    var dueDateOnly = task.dueDateTime ? task.dueDateTime.substring(0, 10) : "";
    var dueTimeOnly = task.dueDateTime ? task.dueDateTime.substring(11, 16) : "";
    var dueDateDisplay = dueDateOnly ? formatDateDisplay(dueDateOnly) : "";
    var checkedAttr = task.checked ? " checked" : "";

    var listBadgeHtml = "";
    if (task.listOverride) {
      listBadgeHtml = '<div style="margin-top:4px;"><span style="display:inline-block;font-size:11px;padding:2px 8px;border-radius:10px;background:var(--accent-light);color:var(--accent);font-weight:600;"><i class="fas fa-list" style="margin-right:4px;"></i>' + escapeHtml(task.listOverride) + '</span></div>';
    }

    card.innerHTML =
      '<div class="task-card-header">' +
        '<input type="checkbox" class="task-check" data-idx="' + idx + '"' + checkedAttr + '>' +
        '<input type="text" class="task-title-input" value="' + escapeAttr(task.title) + '" data-idx="' + idx + '" data-field="title" placeholder="Task title">' +
        '<div class="task-actions">' +
          (task.synced ? '<span class="task-synced"><i class="fas fa-check"></i> Synced</span>' : '') +
          '<button class="task-remove" data-idx="' + idx + '" title="Remove task" type="button"><i class="fas fa-trash-can"></i></button>' +
        '</div>' +
      '</div>' +
      '<textarea class="task-body-input" data-idx="' + idx + '" data-field="body" placeholder="Notes (optional)" rows="' + (task.isEvent ? 2 : 1) + '">' + escapeHtml(task.body) + '</textarea>' +
      '<div class="task-meta">' +
        '<div class="task-due" style="position:relative;">' +
          '<i class="fas fa-calendar-day"></i>' +
          '<button type="button" class="cal-trigger" data-idx="' + idx + '">' +
            (dueDateDisplay ? escapeHtml(dueDateDisplay) : '<span class="placeholder">Set date</span>') +
          '</button>' +
          '<input type="time" data-idx="' + idx + '" data-field="dueTime" value="' + escapeAttr(dueTimeOnly) + '" style="margin-left:4px;">' +
          '<div class="cal-popup" data-cal-idx="' + idx + '"></div>' +
        '</div>' +
      '</div>' +
      listBadgeHtml;

    return card;
  }

  function renderTasks() {
    taskList.innerHTML = "";
    if (state.tasks.length === 0) {
      taskList.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-list"></i><p>No tasks yet. Add tasks manually or go back to input.</p></div>';
      return;
    }

    // Split into event, priority, and other tasks (keeping original indices)
    var priorityItems = [];
    var otherItems = [];
    var eventItems = [];
    state.tasks.forEach(function(task, idx) {
      if (task.isEvent) { eventItems.push({ task: task, idx: idx }); }
      else if (task.priority) { priorityItems.push({ task: task, idx: idx }); }
      else { otherItems.push({ task: task, idx: idx }); }
    });

    var animIdx = 0;

    // Event section
    if (eventItems.length > 0) {
      var eventLabel = document.createElement("div");
      eventLabel.className = "task-section-label priority";
      eventLabel.innerHTML = '<i class="fas fa-ticket"></i> Event Registration (' + eventItems.length + ')';
      taskList.appendChild(eventLabel);

      eventItems.forEach(function(item) {
        taskList.appendChild(renderTaskCard(item.task, item.idx, animIdx++));
      });
    }

    // Divider between event and other sections
    if (eventItems.length > 0 && (priorityItems.length > 0 || otherItems.length > 0)) {
      var divE = document.createElement("div");
      divE.className = "task-section-divider";
      taskList.appendChild(divE);
    }

    // Priority section
    if (priorityItems.length > 0) {
      var priLabel = document.createElement("div");
      priLabel.className = "task-section-label priority";
      priLabel.innerHTML = '<i class="fas fa-fire"></i> Quizzes, Exams &amp; Dictations (' + priorityItems.length + ')';
      taskList.appendChild(priLabel);

      priorityItems.forEach(function(item) {
        taskList.appendChild(renderTaskCard(item.task, item.idx, animIdx++));
      });
    }

    // Divider between sections
    if (priorityItems.length > 0 && otherItems.length > 0) {
      var divider = document.createElement("div");
      divider.className = "task-section-divider";
      taskList.appendChild(divider);
    }

    // Other tasks section
    if (otherItems.length > 0) {
      var otherLabel = document.createElement("div");
      otherLabel.className = "task-section-label";
      otherLabel.innerHTML = '<i class="fas fa-list-check"></i> Other Tasks (' + otherItems.length + ')';
      taskList.appendChild(otherLabel);

      otherItems.forEach(function(item) {
        taskList.appendChild(renderTaskCard(item.task, item.idx, animIdx++));
      });
    }

    // Bind checkbox events
    taskList.querySelectorAll(".task-check").forEach(function(cb) {
      cb.addEventListener("change", function() {
        var i = parseInt(this.getAttribute("data-idx"), 10);
        state.tasks[i].checked = this.checked;
        var card = this.closest(".task-card");
        if (card) {
          if (this.checked) { card.classList.remove("unchecked-task"); }
          else { card.classList.add("unchecked-task"); }
        }
        updateSyncBtnCount();
      });
    });

    // Bind text events
    taskList.querySelectorAll(".task-title-input, .task-body-input").forEach(function(el) {
      el.addEventListener("input", function() {
        var i = parseInt(this.getAttribute("data-idx"), 10);
        var field = this.getAttribute("data-field");
        state.tasks[i][field] = this.value;
        if (field === "title" || field === "body") {
          state.tasks[i].priority = isPriorityTask(state.tasks[i].title, state.tasks[i].body);
        }
      });
    });

    // Bind calendar trigger buttons
    taskList.querySelectorAll(".cal-trigger").forEach(function(btn) {
      btn.addEventListener("click", function(e) {
        e.stopPropagation();
        // Close other open popups
        document.querySelectorAll(".cal-popup.open").forEach(function(p) { p.classList.remove("open"); });
        var idx2 = parseInt(this.getAttribute("data-idx"), 10);
        var popup = taskList.querySelector('.cal-popup[data-cal-idx="' + idx2 + '"]');
        if (!popup) { return; }
        // Determine which month to show
        var task = state.tasks[idx2];
        var showDate = task && task.dueDateTime ? task.dueDateTime.substring(0, 10) : getTodayDate();
        var parts = showDate.split("-");
        var yr = parseInt(parts[0], 10);
        var mo = parseInt(parts[1], 10) - 1;
        buildCalendarGrid(popup, idx2, yr, mo);
        popup.classList.add("open");
      });
    });

    // Bind time input changes
    taskList.querySelectorAll("input[data-field='dueTime']").forEach(function(el) {
      el.addEventListener("input", function() {
        var i = parseInt(this.getAttribute("data-idx"), 10);
        var task = state.tasks[i];
        if (!task) { return; }
        var dateStr = task.dueDateTime ? task.dueDateTime.substring(0, 10) : "";
        if (dateStr && this.value) {
          task.dueDateTime = dateStr + "T" + this.value + ":00";
        }
      });
    });

    // Re-render on title/body blur to re-sort sections if priority changed
    taskList.querySelectorAll(".task-title-input, .task-body-input").forEach(function(el) {
      el.addEventListener("blur", function() {
        var i = parseInt(this.getAttribute("data-idx"), 10);
        var newPri = isPriorityTask(state.tasks[i].title, state.tasks[i].body);
        if (newPri !== state.tasks[i].priority) {
          state.tasks[i].priority = newPri;
          renderTasks();
        }
      });
    });

    taskList.querySelectorAll(".task-remove").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var i = parseInt(this.getAttribute("data-idx"), 10);
        state.tasks.splice(i, 1);
        renderTasks();
      });
    });

    // Auto-resize textareas
    taskList.querySelectorAll(".task-body-input").forEach(function(ta) {
      autoResizeTextarea(ta);
      ta.addEventListener("input", function() { autoResizeTextarea(ta); });
    });

    updateSyncBtnCount();
  }

  function updateSyncBtnCount() {
    var checkedCount = state.tasks.filter(function(t) { return t.checked && !t.synced && t.title.trim(); }).length;
    syncBtn.innerHTML = '<i class="fas fa-cloud-arrow-up"></i> Sync ' + checkedCount + ' task' + (checkedCount !== 1 ? 's' : '') + ' to Microsoft To Do';
  }

  function autoResizeTextarea(ta) {
    ta.style.height = "auto";
    ta.style.height = ta.scrollHeight + "px";
  }

  function escapeHtml(s) {
    var d = document.createElement("div");
    d.textContent = s || "";
    return d.innerHTML;
  }

  // ========== CALENDAR PICKER ==========
  var MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  var DOW_LABELS = ["Su","Mo","Tu","We","Th","Fr","Sa"];

  function formatDateDisplay(dateStr) {
    // dateStr: "YYYY-MM-DD" → "Mon DD, YYYY" e.g. "Feb 18, 2026"
    if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) { return dateStr || ""; }
    var parts = dateStr.split("-");
    var m = parseInt(parts[1], 10) - 1;
    var d = parseInt(parts[2], 10);
    var y = parts[0];
    return MONTH_NAMES[m].substring(0, 3) + " " + d + ", " + y;
  }

  function buildCalendarGrid(popup, taskIdx, year, month) {
    var todayStr = getTodayDate();
    var selectedStr = state.tasks[taskIdx] ? (state.tasks[taskIdx].dueDateTime || "").substring(0, 10) : "";

    var html = '<div class="cal-header">' +
      '<button type="button" class="cal-prev" data-idx="' + taskIdx + '">&lsaquo;</button>' +
      '<span class="cal-month-year">' + MONTH_NAMES[month] + ' ' + year + '</span>' +
      '<button type="button" class="cal-next" data-idx="' + taskIdx + '">&rsaquo;</button>' +
    '</div>' +
    '<div class="cal-grid">';

    // Day-of-week headers (Sun first)
    for (var d = 0; d < 7; d++) {
      html += '<span class="cal-dow">' + DOW_LABELS[d] + '</span>';
    }

    // First day of month and total days
    var firstDay = new Date(year, month, 1).getDay(); // 0=Sun
    var daysInMonth = new Date(year, month + 1, 0).getDate();
    var prevMonthDays = new Date(year, month, 0).getDate();

    // Previous month trailing days
    for (var p = firstDay - 1; p >= 0; p--) {
      var prevDay = prevMonthDays - p;
      var prevM = month === 0 ? 11 : month - 1;
      var prevY = month === 0 ? year - 1 : year;
      var prevStr = prevY + "-" + String(prevM + 1).padStart(2, "0") + "-" + String(prevDay).padStart(2, "0");
      html += '<button type="button" class="cal-day other-month" data-date="' + prevStr + '" data-idx="' + taskIdx + '">' + prevDay + '</button>';
    }

    // Current month days
    for (var i = 1; i <= daysInMonth; i++) {
      var ds = year + "-" + String(month + 1).padStart(2, "0") + "-" + String(i).padStart(2, "0");
      var cls = "cal-day";
      if (ds === todayStr) { cls += " today"; }
      if (ds === selectedStr) { cls += " selected"; }
      html += '<button type="button" class="' + cls + '" data-date="' + ds + '" data-idx="' + taskIdx + '">' + i + '</button>';
    }

    // Next month leading days to fill last row
    var totalCells = firstDay + daysInMonth;
    var remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (var n = 1; n <= remaining; n++) {
      var nextM = month === 11 ? 0 : month + 1;
      var nextY = month === 11 ? year + 1 : year;
      var nextStr = nextY + "-" + String(nextM + 1).padStart(2, "0") + "-" + String(n).padStart(2, "0");
      html += '<button type="button" class="cal-day other-month" data-date="' + nextStr + '" data-idx="' + taskIdx + '">' + n + '</button>';
    }

    html += '</div>';
    html += '<div class="cal-clear-row"><button type="button" class="cal-clear-btn" data-idx="' + taskIdx + '">Clear date</button></div>';

    popup.innerHTML = html;
    popup.setAttribute("data-year", year);
    popup.setAttribute("data-month", month);

    // Bind nav buttons
    popup.querySelector(".cal-prev").addEventListener("click", function(e) {
      e.stopPropagation();
      var nm = month - 1, ny = year;
      if (nm < 0) { nm = 11; ny--; }
      buildCalendarGrid(popup, taskIdx, ny, nm);
    });
    popup.querySelector(".cal-next").addEventListener("click", function(e) {
      e.stopPropagation();
      var nm = month + 1, ny = year;
      if (nm > 11) { nm = 0; ny++; }
      buildCalendarGrid(popup, taskIdx, ny, nm);
    });

    // Bind day clicks
    popup.querySelectorAll(".cal-day").forEach(function(btn) {
      btn.addEventListener("click", function(e) {
        e.stopPropagation();
        var dateVal = this.getAttribute("data-date");
        var idx2 = parseInt(this.getAttribute("data-idx"), 10);
        selectCalendarDate(idx2, dateVal);
        popup.classList.remove("open");
      });
    });

    // Bind clear
    popup.querySelector(".cal-clear-btn").addEventListener("click", function(e) {
      e.stopPropagation();
      var idx2 = parseInt(this.getAttribute("data-idx"), 10);
      selectCalendarDate(idx2, "");
      popup.classList.remove("open");
    });
  }

  function selectCalendarDate(taskIdx, dateStr) {
    var task = state.tasks[taskIdx];
    if (!task) { return; }
    if (dateStr) {
      // Preserve existing time, or default to 09:00
      var existingTime = task.dueDateTime ? task.dueDateTime.substring(11, 16) : "";
      if (!existingTime) { existingTime = "09:00"; }
      task.dueDateTime = dateStr + "T" + existingTime + ":00";
    } else {
      task.dueDateTime = null;
    }
    // Update trigger button text
    var trigger = taskList.querySelector('.cal-trigger[data-idx="' + taskIdx + '"]');
    if (trigger) {
      trigger.innerHTML = dateStr ? escapeHtml(formatDateDisplay(dateStr)) : '<span class="placeholder">Set date</span>';
    }
    // Update time input
    var timeInput = taskList.querySelector('input[data-field="dueTime"][data-idx="' + taskIdx + '"]');
    if (timeInput && dateStr) {
      var t = task.dueDateTime ? task.dueDateTime.substring(11, 16) : "";
      if (!timeInput.value && t) { timeInput.value = t; }
    }
  }

  // Close all calendar popups when clicking outside
  document.addEventListener("click", function(e) {
    if (!e.target.closest(".cal-popup") && !e.target.closest(".cal-trigger")) {
      document.querySelectorAll(".cal-popup.open").forEach(function(p) {
        p.classList.remove("open");
      });
    }
  });

  function escapeAttr(s) {
    return (s || "").replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  // ========== ADD TASK MANUALLY ==========
  addTaskBtn.addEventListener("click", function() {
    state.tasks.push({
      id: "task-" + Date.now(),
      title: "",
      body: "",
      dueDateTime: null,
      priority: false,
      checked: true,
      synced: false
    });
    renderTasks();
    // Focus the new task's title
    var lastTitle = taskList.querySelector(".task-card:last-child .task-title-input");
    if (lastTitle) { lastTitle.focus(); }
  });

  // ========== BACK TO UPLOAD ==========
  backToUploadBtn.addEventListener("click", function() {
    updateStepper(2);
    showSection("upload");
  });

  // ========== SYNC FLOW ==========
  syncBtn.addEventListener("click", function() {
    var checkedUnsynced = state.tasks.filter(function(t) { return t.checked && !t.synced && t.title.trim(); });
    if (checkedUnsynced.length === 0) {
      showToast("No checked tasks to sync", "error");
      return;
    }
    openListModal();
  });

  // ========== LIST MODAL ==========
  // Helper: match a listOverride string against available lists
  function matchListOverride(overrideName, lists) {
    if (!overrideName) { return null; }
    var lower = overrideName.toLowerCase();
    for (var i = 0; i < lists.length; i++) {
      if (lists[i].displayName.toLowerCase() === lower) {
        return lists[i];
      }
    }
    return null;
  }

  // Helper: capitalize first letter of each word
  function capitalizeFirstLetter(str) {
    if (!str) { return str; }
    return str.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
  }

  // Track dynamic modal sections for custom/unmatched lists
  var modalCustomData = []; // { key, matchedListName, taskCount, selectEl }
  var modalUnmatchedData = []; // { key, rawName, suggestedName, taskCount, selectEl, inputEl }

  function openListModal() {
    // Count checked tasks by category — separate tasks WITH overrides from those without
    var checkedTasks = state.tasks.filter(function(t) { return t.checked && !t.synced && t.title.trim(); });

    // Tasks WITHOUT overrides: categorize normally
    var checkedPriority = checkedTasks.filter(function(t) { return !t.listOverride && t.priority; });
    var checkedOther = checkedTasks.filter(function(t) { return !t.listOverride && !t.priority && !t.isEvent; });
    var checkedEvent = checkedTasks.filter(function(t) { return !t.listOverride && t.isEvent; });

    // Tasks WITH overrides: group by listOverride value
    var overrideTasks = checkedTasks.filter(function(t) { return !!t.listOverride; });
    var overrideGroups = {};
    overrideTasks.forEach(function(t) {
      var key = t.listOverride.toLowerCase().trim();
      if (!overrideGroups[key]) {
        overrideGroups[key] = { rawName: t.listOverride, tasks: [] };
      }
      overrideGroups[key].tasks.push(t);
    });

    // Show/hide standard sections (order: Priority → Other → Event)
    if (checkedPriority.length > 0) {
      modalPrioritySection.style.display = "";
      modalPriorityLabel.textContent = "Priority (" + checkedPriority.length + ")";
      newListInputPriority.value = "";
    } else {
      modalPrioritySection.style.display = "none";
    }

    if (checkedOther.length > 0) {
      modalOtherSection.style.display = "";
      modalOtherLabel.textContent = "Other tasks (" + checkedOther.length + ")";
      newListInputOther.value = "";
    } else {
      modalOtherSection.style.display = "none";
    }

    if (checkedEvent.length > 0) {
      modalEventSection.style.display = "";
      modalEventLabel.textContent = "Event registration (" + checkedEvent.length + ")";
      newListInputEvent.value = "";
    } else {
      modalEventSection.style.display = "none";
    }

    // Clear dynamic sections
    $id("modalCustomSections").innerHTML = "";
    $id("modalUnmatchedSections").innerHTML = "";
    modalCustomData = [];
    modalUnmatchedData = [];

    // Store override groups for populating after list fetch
    state._overrideGroups = overrideGroups;

    listModal.classList.add("open");
    fetchTaskLists();
  }

  function closeListModal() {
    listModal.classList.remove("open");
  }

  listModalCancel.addEventListener("click", closeListModal);
  listModal.addEventListener("click", function(e) {
    if (e.target === listModal) { closeListModal(); }
  });

  function populateListSelect(selectEl, lists, defaultName) {
    selectEl.innerHTML = "";
    var matchedIdx = -1;
    lists.forEach(function(list, i) {
      var opt = document.createElement("option");
      opt.value = list.id;
      opt.textContent = list.displayName;
      selectEl.appendChild(opt);
      if (defaultName && list.displayName.toLowerCase() === defaultName.toLowerCase()) {
        matchedIdx = i;
      }
    });
    if (matchedIdx !== -1) {
      selectEl.selectedIndex = matchedIdx;
    }
    if (lists.length === 0) {
      selectEl.innerHTML = '<option value="">No lists found</option>';
    }
  }

  async function fetchTaskLists() {
    var loadingHtml = '<option value="">Loading…</option>';
    listSelectPriority.innerHTML = loadingHtml;
    listSelectOther.innerHTML = loadingHtml;
    listSelectEvent.innerHTML = loadingHtml;

    try {
      var token = await getAccessToken();
      var resp = await fetch("https://graph.microsoft.com/v1.0/me/todo/lists", {
        headers: { Authorization: "Bearer " + token }
      });
      if (!resp.ok) {
        var detail = await parseGraphError(resp);
        if (detail.isAuthError) {
          var errHtml = '<option value="">Auth error — re-authenticate</option>';
          listSelectPriority.innerHTML = errHtml;
          listSelectOther.innerHTML = errHtml;
          listSelectEvent.innerHTML = errHtml;
          showToast(formatGraphError(detail), "error");
          return;
        }
        throw new Error(formatGraphError(detail));
      }
      var data = await resp.json();
      state.lists = data.value || [];
      populateListSelect(listSelectPriority, state.lists, "Theo Quiz and Dictation");
      populateListSelect(listSelectOther, state.lists, "Theo Homework");
      populateListSelect(listSelectEvent, state.lists, "Household Tasks");

      // Build dynamic custom/unmatched sections from override groups
      buildOverrideSections(state.lists);
    } catch(err) {
      var errHtml2 = '<option value="">Error loading lists</option>';
      listSelectPriority.innerHTML = errHtml2;
      listSelectOther.innerHTML = errHtml2;
      listSelectEvent.innerHTML = errHtml2;
      showToast("Could not load task lists: " + err.message, "error");
    }
  }

  function buildOverrideSections(lists) {
    var overrideGroups = state._overrideGroups || {};
    var customContainer = $id("modalCustomSections");
    var unmatchedContainer = $id("modalUnmatchedSections");
    customContainer.innerHTML = "";
    unmatchedContainer.innerHTML = "";
    modalCustomData = [];
    modalUnmatchedData = [];

    Object.keys(overrideGroups).forEach(function(key) {
      var group = overrideGroups[key];
      var matched = matchListOverride(group.rawName, lists);
      var taskCount = group.tasks.length;

      if (matched) {
        // === MATCHED: Custom list section ===
        var section = document.createElement("div");
        section.className = "modal-custom-section";
        section.innerHTML =
          '<div class="modal-custom-label">' +
            '<i class="fas fa-thumbtack" style="color:var(--accent);"></i>' +
            '<span class="custom-matched">Custom list: ' + escapeHtml(matched.displayName) + ' (' + taskCount + ')</span>' +
          '</div>' +
          '<div class="field" style="margin-bottom:8px;">' +
            '<select class="custom-list-select"></select>' +
          '</div>';
        customContainer.appendChild(section);

        var selectEl = section.querySelector(".custom-list-select");
        populateListSelect(selectEl, lists, matched.displayName);

        modalCustomData.push({
          key: key,
          matchedListName: matched.displayName,
          taskCount: taskCount,
          selectEl: selectEl
        });
      } else {
        // === UNMATCHED: No matching list section ===
        var suggestedName = capitalizeFirstLetter(group.rawName.trim());
        var section2 = document.createElement("div");
        section2.className = "modal-custom-section";
        section2.innerHTML =
          '<div class="modal-custom-label">' +
            '<i class="fas fa-triangle-exclamation" style="color:var(--danger);"></i>' +
            '<span class="custom-unmatched">No matching list found (' + taskCount + ')</span>' +
          '</div>' +
          '<div class="modal-unmatched-hint">The specified list "' + escapeHtml(group.rawName) + '" was not found. You can create it or pick an existing list.</div>' +
          '<div class="field" style="margin-bottom:8px;">' +
            '<select class="unmatched-list-select">' +
              '<option value="__create__">Create new list</option>' +
            '</select>' +
          '</div>' +
          '<div class="field" style="margin-bottom:16px;">' +
            '<input type="text" class="modal-new-list-input" value="' + escapeAttr(suggestedName) + '" placeholder="New list name">' +
          '</div>';
        unmatchedContainer.appendChild(section2);

        var selectEl2 = section2.querySelector(".unmatched-list-select");
        var inputEl = section2.querySelector(".modal-new-list-input");

        // Add existing lists as options after "Create new list"
        lists.forEach(function(list) {
          var opt = document.createElement("option");
          opt.value = list.id;
          opt.textContent = list.displayName;
          selectEl2.appendChild(opt);
        });

        // Toggle input enabled/disabled based on dropdown
        selectEl2.addEventListener("change", function() {
          if (selectEl2.value === "__create__") {
            inputEl.disabled = false;
            inputEl.style.opacity = "";
          } else {
            inputEl.disabled = true;
          }
        });

        modalUnmatchedData.push({
          key: key,
          rawName: group.rawName,
          suggestedName: suggestedName,
          taskCount: taskCount,
          selectEl: selectEl2,
          inputEl: inputEl
        });
      }
    });
  }

  // Helper: resolve a list ID from a select + new-name input pair
  async function resolveListId(selectEl, newNameInput) {
    var newName = newNameInput.value.trim();
    if (newName) {
      var listToken = await getAccessToken();
      var resp = await fetch("https://graph.microsoft.com/v1.0/me/todo/lists", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + listToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ displayName: newName })
      });
      if (!resp.ok) {
        var listErrDetail = await parseGraphError(resp);
        throw new Error(formatGraphError(listErrDetail));
      }
      var newList = await resp.json();
      return newList.id;
    }
    return selectEl.value;
  }

  // ========== SYNC EXECUTION (shared by modal confirm and lite mode) ==========
  // eventListId is optional — if provided, event tasks route there instead of otherListId
  // overrideListIds is optional — map of override key → list ID for custom/unmatched overrides
  async function executeSyncTasks(priorityListId, otherListId, eventListId, overrideListIds) {
    updateStepper(4);
    showSection("sync");
    syncingCard.style.display = "";
    syncDoneCard.style.display = "none";
    syncProgressBar.style.width = "0%";

    // Sync only checked, unsynced tasks
    var unsyncedTasks = state.tasks.filter(function(t) { return t.checked && !t.synced && t.title.trim(); });
    var total = unsyncedTasks.length;
    var done = 0;
    var errors = 0;
    var firstErrorDetail = null;
    var hadAuthError = false;
    var tz = timezoneSelect.value || "UTC";

    // Prepare photo base64 for attachment (strip data URL prefix)
    var photoBase64 = null;
    var photoFileName = "todo-list-photo.jpg";
    var photoMime = "image/jpeg";
    if (state.photoDataUrl) {
      var commaIdx = state.photoDataUrl.indexOf(",");
      if (commaIdx !== -1) {
        photoBase64 = state.photoDataUrl.substring(commaIdx + 1);
        var mimeMatch = state.photoDataUrl.match(/^data:([^;]+);/);
        if (mimeMatch) { photoMime = mimeMatch[1]; }
        if (state.uploadedFile && state.uploadedFile.name) {
          photoFileName = state.uploadedFile.name;
        }
      }
    }

    for (var i = 0; i < unsyncedTasks.length; i++) {
      var task = unsyncedTasks[i];
      // Determine target list: override takes precedence, then normal routing
      var listId;
      if (task.listOverride && overrideListIds) {
        var overrideKey = task.listOverride.toLowerCase().trim();
        listId = overrideListIds[overrideKey] || null;
      }
      if (!listId) {
        listId = task.priority ? priorityListId : (task.isEvent && eventListId ? eventListId : otherListId);
      }
      syncStatusText.textContent = "Creating task " + (i + 1) + " of " + total + "…";
      syncProgressBar.style.width = (((i + 1) / total) * 100) + "%";

      try {
        var taskBody = {
          title: task.title
        };
        if (task.body) {
          taskBody.body = {
            content: task.body,
            contentType: "text"
          };
        }
        if (task.dueDateTime) {
          var normalizedDT = normalizeDateTimeForGraph(task.dueDateTime);
          if (normalizedDT) {
            taskBody.dueDateTime = {
              dateTime: normalizedDT,
              timeZone: tz
            };
          }
        }
        // Include reminder in creation request for event tasks
        if (task.reminderDateTime) {
          taskBody.isReminderOn = true;
          taskBody.reminderDateTime = {
            dateTime: task.reminderDateTime,
            timeZone: tz
          };
        }

        var taskToken = await getAccessToken();
        var tresp = await fetch("https://graph.microsoft.com/v1.0/me/todo/lists/" + listId + "/tasks", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + taskToken,
            "Content-Type": "application/json",
            Prefer: "outlook.timezone=\"" + tz + "\""
          },
          body: JSON.stringify(taskBody)
        });

        if (!tresp.ok) {
          var errDetail = await parseGraphError(tresp);
          if (!firstErrorDetail) { firstErrorDetail = errDetail; }
          if (errDetail.isAuthError) { hadAuthError = true; }
          throw new Error(formatGraphError(errDetail));
        }

        var createdTask = await tresp.json();

        // Attach photo to the created task
        if (photoBase64 && createdTask.id) {
          syncStatusText.textContent = "Attaching photo to task " + (i + 1) + " of " + total + "…";
          try {
            var attachToken = await getAccessToken();
            var attachResp = await fetch(
              "https://graph.microsoft.com/v1.0/me/todo/lists/" + listId + "/tasks/" + createdTask.id + "/attachments",
              {
                method: "POST",
                headers: {
                  Authorization: "Bearer " + attachToken,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  "@odata.type": "#microsoft.graph.taskFileAttachment",
                  name: photoFileName,
                  contentType: photoMime,
                  contentBytes: photoBase64
                })
              }
            );
            if (!attachResp.ok) {
              console.log("Photo attachment failed for task: " + JSON.stringify({ title: task.title, status: attachResp.status }));
            }
          } catch(attachErr) {
            console.log("Photo attachment error: " + attachErr.message);
          }
        }

        // Mark as synced in state
        var idx = state.tasks.indexOf(task);
        if (idx !== -1) { state.tasks[idx].synced = true; }
        done++;
      } catch(err) {
        errors++;
        console.log("Error syncing task: " + JSON.stringify({ title: task.title, error: err.message }));
        // If auth error, skip remaining tasks — they will all fail the same way
        if (hadAuthError) {
          errors += (unsyncedTasks.length - i - 1);
          break;
        }
      }
    }

    // Show results
    syncingCard.style.display = "none";
    syncDoneCard.style.display = "";

    // Reset buttons
    reAuthBtn.style.display = "none";
    retryFailedBtn.style.display = "none";
    syncErrorDetail.style.display = "none";
    syncErrorDetail.innerHTML = "";

    if (errors === 0) {
      syncDoneIcon.innerHTML = '<i class="fas fa-circle-check"></i>';
      syncDoneIcon.style.color = "var(--success)";
      syncDoneTitle.textContent = "All synced!";
      syncDoneText.textContent = done + " task" + (done > 1 ? "s" : "") + " synced to Microsoft To Do.";
    } else {
      syncDoneIcon.innerHTML = '<i class="fas fa-triangle-exclamation"></i>';
      syncDoneIcon.style.color = "var(--danger)";
      syncDoneTitle.textContent = done > 0 ? "Partially synced" : "Sync failed";
      syncDoneText.textContent = done + " synced, " + errors + " failed.";

      // Show detailed error guidance
      if (firstErrorDetail) {
        syncErrorDetail.style.display = "";
        syncErrorDetail.innerHTML = buildErrorGuidanceHtml(firstErrorDetail);
      }

      // Show action buttons
      if (hadAuthError) {
        reAuthBtn.style.display = "";
      }
      retryFailedBtn.style.display = "";
    }
  }

  listModalConfirm.addEventListener("click", async function() {
    var hasPriority = modalPrioritySection.style.display !== "none";
    var hasOther = modalOtherSection.style.display !== "none";
    var hasEvent = modalEventSection.style.display !== "none";

    // Validate: each visible section needs a list selected or new name
    if (hasPriority && !listSelectPriority.value && !newListInputPriority.value.trim()) {
      showToast("Please select or create a list for priority tasks", "error");
      return;
    }
    if (hasOther && !listSelectOther.value && !newListInputOther.value.trim()) {
      showToast("Please select or create a list for other tasks", "error");
      return;
    }
    if (hasEvent && !listSelectEvent.value && !newListInputEvent.value.trim()) {
      showToast("Please select or create a list for event tasks", "error");
      return;
    }

    // Validate unmatched sections: if "Create new list" is selected, need a name
    for (var u = 0; u < modalUnmatchedData.length; u++) {
      var um = modalUnmatchedData[u];
      if (um.selectEl.value === "__create__" && !um.inputEl.value.trim()) {
        showToast("Please enter a name for the new list", "error");
        return;
      }
    }

    closeListModal();

    // Resolve list IDs (create new lists if needed)
    var priorityListId = null;
    var otherListId = null;
    var eventListId = null;
    // Map: override key → resolved list ID
    var overrideListIds = {};

    updateStepper(4);
    showSection("sync");
    syncingCard.style.display = "";
    syncDoneCard.style.display = "none";
    syncProgressBar.style.width = "0%";

    try {
      if (hasPriority) {
        syncStatusText.textContent = "Preparing priority task list…";
        priorityListId = await resolveListId(listSelectPriority, newListInputPriority);
      }
      if (hasOther) {
        syncStatusText.textContent = "Preparing other task list…";
        otherListId = await resolveListId(listSelectOther, newListInputOther);
      }
      if (hasEvent) {
        syncStatusText.textContent = "Preparing event task list…";
        eventListId = await resolveListId(listSelectEvent, newListInputEvent);
      }

      // Resolve custom list sections (matched overrides)
      for (var c = 0; c < modalCustomData.length; c++) {
        var cd = modalCustomData[c];
        syncStatusText.textContent = "Preparing \"" + cd.matchedListName + "\" list…";
        overrideListIds[cd.key] = cd.selectEl.value;
      }

      // Resolve unmatched list sections
      for (var u2 = 0; u2 < modalUnmatchedData.length; u2++) {
        var umd = modalUnmatchedData[u2];
        if (umd.selectEl.value === "__create__") {
          // Create new list
          var newName = umd.inputEl.value.trim();
          syncStatusText.textContent = "Creating \"" + newName + "\" list…";
          var newListId = await findOrCreateList(state.lists || [], newName);
          overrideListIds[umd.key] = newListId;
        } else {
          // Use existing selected list
          overrideListIds[umd.key] = umd.selectEl.value;
        }
      }
    } catch(err) {
      showToast("Failed to create list: " + err.message, "error");
      updateStepper(3);
      showSection("review");
      return;
    }

    await executeSyncTasks(priorityListId, otherListId, eventListId, overrideListIds);
  });

  // ========== RE-AUTH BUTTON ==========
  reAuthBtn.addEventListener("click", async function() {
    // Try to silently re-acquire token via MSAL first
    if (state.msalInstance) {
      try {
        var token = await getAccessToken();
        if (token) {
          showToast("Token refreshed successfully. You can retry now.", "success");
          return;
        }
      } catch(ignored) { /* fall through to full re-auth */ }
    }
    state.accessToken = "";
    state.tokenExpiresAt = 0;
    stopTokenExpiryTracker();
    updateStepper(1);
    showSection("auth");
    showToast("Please sign in again", "info");
  });

  // ========== RETRY FAILED BUTTON ==========
  retryFailedBtn.addEventListener("click", function() {
    updateStepper(3);
    showSection("review");
    renderTasks();
  });

  // ========== NEW SCAN ==========
  newScanBtn.addEventListener("click", function() {
    state.tasks = [];
    state.uploadedFile = null;
    state.photoDataUrl = null;
    previewImg.src = "";
    uploadPreview.style.display = "none";
    uploadZone.style.display = "";
    imageInput.value = "";
    // Reset smart input
    smartTextInput.value = "";
    smartPasteDataUrl = null;
    smartPasteImg.src = "";
    smartPastePreview.style.display = "none";
    lastUserInstruction = "";
    lastInputHadText = false;
    extractBtn.disabled = true;
    taskList.innerHTML = "";
    newListInputPriority.value = "";
    newListInputOther.value = "";
    newListInputEvent.value = "";
    $id("modalCustomSections").innerHTML = "";
    $id("modalUnmatchedSections").innerHTML = "";
    modalCustomData = [];
    modalUnmatchedData = [];
    cachedListNames = [];
    updateStepper(2);
    showSection("upload");
  });

  // ========== BOOT: TRY AUTO-LOGIN ==========
  tryAutoLogin();

})();
</script>
</body>
</html>
